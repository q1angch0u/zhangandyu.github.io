<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><title>Hive-SQL学习 | 怪兽宇的小站</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','127783955','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Hive-SQL学习</h1><a id="logo" href="/.">怪兽宇的小站</a><p class="description">脚踏实地，仰望星空!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/tool/"><i class="fa fa-yelp"> 工具</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Hive-SQL学习</h1><div class="post-meta">2019-04-18<span> | </span><span class="category"><a href="/categories/数据分析技能/">数据分析技能</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 9.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 40</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2019/04/18/Hive-SQL学习/#vcomment"><span class="valine-comment-count" data-xid="/2019/04/18/Hive-SQL学习/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#数据库与表的增删改查"><span class="toc-number">1.</span> <span class="toc-text">数据库与表的增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库"><span class="toc-number">1.1.</span> <span class="toc-text">数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据表"><span class="toc-number">1.2.</span> <span class="toc-text">数据表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内部表与外部表"><span class="toc-number">1.3.</span> <span class="toc-text">内部表与外部表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查询"><span class="toc-number">2.</span> <span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#select…from…"><span class="toc-number">2.1.</span> <span class="toc-text">select…from…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#where"><span class="toc-number">2.2.</span> <span class="toc-text">where</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#group-by"><span class="toc-number">2.3.</span> <span class="toc-text">group by</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#order-by"><span class="toc-number">2.4.</span> <span class="toc-text">order by</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#having"><span class="toc-number">2.5.</span> <span class="toc-text">having</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#limit"><span class="toc-number">2.6.</span> <span class="toc-text">limit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#表连接"><span class="toc-number">2.7.</span> <span class="toc-text">表连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#join"><span class="toc-number">2.7.1.</span> <span class="toc-text">join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并集：union-与-union-all"><span class="toc-number">2.7.2.</span> <span class="toc-text">并集：union 与 union all</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#交集：intersect"><span class="toc-number">2.7.3.</span> <span class="toc-text">交集：intersect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#差集：except"><span class="toc-number">2.7.4.</span> <span class="toc-text">差集：except</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#函数"><span class="toc-number">3.</span> <span class="toc-text">函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#聚合函数"><span class="toc-number">3.1.</span> <span class="toc-text">聚合函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#时间函数"><span class="toc-number">3.2.</span> <span class="toc-text">时间函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#求留存率"><span class="toc-number">3.2.1.</span> <span class="toc-text">求留存率</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条件判断：case-when-与-if"><span class="toc-number">3.3.</span> <span class="toc-text">条件判断：case when 与 if</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行转列"><span class="toc-number">3.4.</span> <span class="toc-text">行转列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#列转行"><span class="toc-number">3.5.</span> <span class="toc-text">列转行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#窗口函数"><span class="toc-number">3.6.</span> <span class="toc-text">窗口函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排序函数"><span class="toc-number">3.7.</span> <span class="toc-text">排序函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#字符串函数"><span class="toc-number">3.8.</span> <span class="toc-text">字符串函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#空字段赋值"><span class="toc-number">3.9.</span> <span class="toc-text">空字段赋值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看系统内置函数"><span class="toc-number">3.10.</span> <span class="toc-text">查看系统内置函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hive避免数据倾斜"><span class="toc-number">4.</span> <span class="toc-text">Hive避免数据倾斜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#小表Join大表"><span class="toc-number">4.1.</span> <span class="toc-text">小表Join大表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大表JOIN大表"><span class="toc-number">4.2.</span> <span class="toc-text">大表JOIN大表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#count-distinct-去重统计"><span class="toc-number">4.3.</span> <span class="toc-text">count(distinct) 去重统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#避免笛卡尔积"><span class="toc-number">4.4.</span> <span class="toc-text">避免笛卡尔积</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#行列过滤"><span class="toc-number">4.5.</span> <span class="toc-text">行列过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#union-all-子查询避免中使用-group-by等"><span class="toc-number">4.6.</span> <span class="toc-text">union all 子查询避免中使用 group by等</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#避免不同数据类型进行关联"><span class="toc-number">4.7.</span> <span class="toc-text">避免不同数据类型进行关联</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#用python脚本连接数据库"><span class="toc-number">5.</span> <span class="toc-text">用python脚本连接数据库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他拓展"><span class="toc-number">6.</span> <span class="toc-text">其他拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#group-by-升级版"><span class="toc-number">6.1.</span> <span class="toc-text">group by 升级版</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="数据库与表的增删改查"><a href="#数据库与表的增删改查" class="headerlink" title="数据库与表的增删改查"></a>数据库与表的增删改查</h1><h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><ul>
<li><p>create database-创建新数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建zhang数据库</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> zhang </span><br><span class="line"></span><br><span class="line"><span class="comment">--制定数据库的位置</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span>  <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> zhang location <span class="string">'/zhang.db'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>alter database-修改数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---增加数据库属性</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> zhang <span class="keyword">set</span> dbproperties(<span class="string">"CTtime"</span>= <span class="string">"2020-05-01"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>drop database -删除数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---数据库下无表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> zhang;</span><br><span class="line"></span><br><span class="line"><span class="comment">---数据库下有表，-强制删除</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> zhang <span class="keyword">cascade</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>选择数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> android;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重置默认数据库</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">default</span> android;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看所在的数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--模糊查询</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span> <span class="keyword">like</span> <span class="string">"s%"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 查询数据库信息</span></span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">database</span>  zhang;</span><br><span class="line"><span class="comment">---查询数据库扩展属性</span></span><br><span class="line">desc database extended zhang;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h2><ul>
<li><p>create table-创建新表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">external</span>] <span class="keyword">table</span> [<span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span>] table_name </span><br><span class="line"></span><br><span class="line">[(col_name data_type [<span class="keyword">comment</span> col_comment],....)]</span><br><span class="line">[partitioned <span class="keyword">by</span> (col_name data_type [<span class="keyword">comment</span> col_comment],..)]</span><br><span class="line">[clustered <span class="keyword">by</span> (col_name, col_name, ...)]</span><br><span class="line">[<span class="keyword">row</span> <span class="keyword">format</span> row_format]</span><br><span class="line">[<span class="keyword">stored</span> <span class="keyword">as</span> file_format]</span><br><span class="line">[location hdfs_path]</span><br><span class="line"></span><br><span class="line"><span class="comment">--- create table 创建指定名称的表，如果相同名称的表已存在，则用if not exists 选项来忽略这个异常。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--extername 关键字让用户创建一个外部表</span></span><br><span class="line"><span class="comment">---partitioned by  分区：分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过where子句的表达式来选择查询所需的指定分区，提高查询效率。</span></span><br><span class="line"><span class="comment">--clustered by 分桶</span></span><br><span class="line"><span class="comment">--row format  字段之间的分隔符</span></span><br><span class="line"><span class="comment">---stored as 文件存储格式</span></span><br><span class="line"><span class="comment">--location， 指定表在HDFS上的存储位置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">---在zhang库中创建test表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> dept(</span><br><span class="line">    deptid <span class="built_in">int</span>, </span><br><span class="line">    dname <span class="keyword">string</span>, </span><br><span class="line">    loc <span class="built_in">int</span>) </span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>update-更新数据库中的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表名</span><br><span class="line"><span class="keyword">set</span>  需更新的列名<span class="number">1</span>= 新值<span class="number">1</span>, 需更新的列名<span class="number">2</span>=新值<span class="number">2</span>,...</span><br><span class="line"><span class="keyword">where</span>  列名 = 某个原有的值</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> Websites </span><br><span class="line"><span class="keyword">SET</span> alexa=<span class="string">'5000'</span>, country=<span class="string">'USA'</span> <span class="comment">--更新的数据</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'菜鸟教程'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>insert into() -向数据库中插入新数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名（列名<span class="number">1</span>,列名<span class="number">2</span>,列名<span class="number">3.</span>..)</span><br><span class="line"><span class="keyword">values</span>(值<span class="number">1</span>, 值<span class="number">2</span>, 值<span class="number">3.</span>..)</span><br></pre></td></tr></table></figure>
</li>
<li><p>delete-从数据库中删除数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">column</span> = value...</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> Websites</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'Facebook'</span> <span class="keyword">AND</span> country=<span class="string">'USA'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--删除表中所有的行，表结果不变</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>
</li>
<li><p>alter table- 修改数据库表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--清楚表中数据,删除掉指定分区</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> shphonefeature <span class="keyword">DROP</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="keyword">PARTITION</span>(<span class="keyword">year</span> = <span class="number">2015</span>, <span class="keyword">month</span> = <span class="number">10</span>, <span class="keyword">day</span> = <span class="number">1</span>);</span><br><span class="line"><span class="comment">---lter table test.mon_mau_list drop partition (hit_mon = '&#123;0&#125;')</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>drop table - 删除表</p>
</li>
<li>create index -创建索引</li>
<li>drop index -删除索引</li>
<li><p>refresh table 表名 - 刷新数据表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refresh table computer_log.client_ios_log</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前使用的数据库中有哪些表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看非当前使用的数据库中有哪些表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">in</span> myhive;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看数据库中以 android 开头的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> android;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'android*'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看表的详细信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc formatted android</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询分区表有多少分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">partitions</span> dept_partition;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看分区表结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc formatted dept_partition</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table dept_partition add partition(month=&apos;201705&apos;) partition(month=&apos;201704&apos;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table dept_partition drop partition (month=&apos;201705&apos;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="内部表与外部表"><a href="#内部表与外部表" class="headerlink" title="内部表与外部表"></a>内部表与外部表</h2><ul>
<li><p>内部表(管理表)：默认创建内部表， 删除表会删除所有数据</p>
</li>
<li><p>外部表： 删除表不会删除这份数据，不过描述表的元数据信息会被删除掉。</p>
</li>
<li><p>原始日志数据应该建立外部表（避免误删）， 用到的中间表、结果表使用内部表存储。 </p>
</li>
<li><p>查看表是内部表还是外部表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看表信息</span></span><br><span class="line">desc  formatted  table_name</span><br></pre></td></tr></table></figure>
</li>
<li><p>内部表与外部表的相互转换</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---内部表转换为外部表</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">set</span> tblproperties(<span class="string">'EXTERNAL'</span> = <span class="string">'true'</span>) <span class="comment">---单引号、大小写不能变</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---外部表转化为内部表</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">set</span> tbproperties(<span class="string">'EXTERNAL'</span> = <span class="string">'false'</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><h2 id="select…from…"><a href="#select…from…" class="headerlink" title="select…from…"></a>select…from…</h2><ul>
<li><p>加入表中一列含有多个元素， 我们可以只查找此列的第一个元素</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, subord[<span class="number">0</span>] <span class="keyword">from</span> employees;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用 “点” 符号， 类似：表的别名 . 列名 这样的用法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span>  <span class="keyword">name</span>, address.city  <span class="keyword">from</span>  employees;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用正则表达式，可以选出所有列名以 price 作为前缀的列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  <span class="string">'price.*'</span>  <span class="keyword">from</span>  stocks;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用列值进行计算</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">account</span>), <span class="keyword">avg</span>(salary) <span class="keyword">from</span> employees;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用别名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  <span class="keyword">count</span>(<span class="keyword">distinct</span> acount) <span class="keyword">as</span> uv   <span class="keyword">from</span>   employees;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果用 distinct, select 后面必须直接跟 distinct</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select  distinct user_account, province from    computer_viedata</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="where"><a href="#where" class="headerlink" title="where"></a>where</h2><ul>
<li>关系型运算符优先级高到低为：not - and - or</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employees <span class="keyword">where</span> country = <span class="string">'us'</span> <span class="keyword">and</span> state = <span class="string">'ca'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employees <span class="keyword">where</span> country  <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'us'</span>, <span class="string">'china'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>数学运算符与关系运算符</li>
</ul>
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加法</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
</tr>
<tr>
<td>/</td>
<td>除法</td>
</tr>
<tr>
<td>%</td>
<td>取余</td>
</tr>
<tr>
<td>&amp;</td>
<td>与</td>
</tr>
<tr>
<td>\</td>
<td>或</td>
</tr>
<tr>
<td>^</td>
<td>异或</td>
</tr>
<tr>
<td>~</td>
<td>取反</td>
</tr>
<tr>
<td><strong>操作符</strong></td>
<td><strong>描述</strong></td>
</tr>
<tr>
<td>A=B</td>
<td>如果A=B，则返回True,否则返回False</td>
</tr>
<tr>
<td>A&lt;=&gt;B</td>
<td>如果A和B都为NULL，则返回True,其他的和等号操作结果一致，如果任意为Null,则结果为null</td>
</tr>
<tr>
<td>A&lt;&gt;B,A!=B</td>
<td>A或B为Null, 则返回Null,如果A不等于B，则返回True,否则返回False</td>
</tr>
<tr>
<td>A&lt;B</td>
<td>–</td>
</tr>
<tr>
<td>A&lt;=B</td>
<td>–</td>
</tr>
<tr>
<td>A&gt;B</td>
<td>–</td>
</tr>
<tr>
<td>A&gt;=b</td>
<td>–</td>
</tr>
<tr>
<td>A[not] between  B and C</td>
<td>—</td>
</tr>
<tr>
<td>A is null</td>
<td>—</td>
</tr>
<tr>
<td>A is not null</td>
<td>—</td>
</tr>
<tr>
<td>in</td>
<td>–</td>
</tr>
<tr>
<td>A [NOT] like B</td>
<td>–</td>
</tr>
<tr>
<td>A rlike B, A REGEXP B</td>
<td>—</td>
</tr>
<tr>
<td><strong>逻辑运算</strong></td>
<td><strong>描述</strong></td>
</tr>
<tr>
<td>and</td>
<td>—</td>
</tr>
<tr>
<td>or</td>
<td>–</td>
</tr>
<tr>
<td>not</td>
<td>—</td>
</tr>
</tbody>
</table>
<ul>
<li>like、rlike</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---like、 rlike </span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, address.street <span class="keyword">from</span> employees </span><br><span class="line"><span class="keyword">where</span> address.street <span class="keyword">rlike</span> <span class="string">'.*(beijing|shanghai).*'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, address.street <span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> address.street <span class="keyword">like</span> <span class="string">'%beijing%'</span> <span class="keyword">or</span> address.street <span class="keyword">like</span> <span class="string">'%shanghai%'</span>;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>通配符</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>%</td>
<td>匹配0个或任意多个字符</td>
</tr>
<tr>
<td>_</td>
<td>匹配任意一个字符</td>
</tr>
<tr>
<td>escape</td>
<td>转义字符，可匹配%和_。如SELECT * FROM table_name WHERE column_name LIKE ‘/%/_%_’ ESCAPE’/‘</td>
</tr>
<tr>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>.</td>
<td>匹配任意单个字 符</td>
</tr>
<tr>
<td>*</td>
<td>匹配0个或多个前一个得到的字符</td>
</tr>
<tr>
<td>[]</td>
<td>含有任意一个[]内的字符，[ab]*可匹配空串、a、b、或者由任意个a和b组成的字符串。</td>
</tr>
<tr>
<td>^</td>
<td>匹配开头，如^s匹配以s或者S开头的字符串</td>
</tr>
<tr>
<td>$</td>
<td>匹配结尾，如s$匹配以s结尾的字符串。</td>
</tr>
<tr>
<td>{n}</td>
<td>匹配前一个字符反复n次。</td>
</tr>
</tbody>
</table>
<h2 id="group-by"><a href="#group-by" class="headerlink" title="group by"></a>group by</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 对结果进行分类</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">year</span>(ymd), <span class="keyword">avg</span>(price_close) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    stocks</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     <span class="keyword">exchange</span> = <span class="string">'nasdaq'</span> <span class="keyword">and</span> symbol = <span class="string">'aapl'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">year</span>(ymd)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">year</span>(ymd) <span class="keyword">desc</span>;  <span class="comment">--desc 从高到低排列</span></span><br></pre></td></tr></table></figure>
<h2 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--对查询的所有结果进行排序, 可在字段加 DESC 关键字， 进行降序排序。 （默认 ASC， 升序）</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="keyword">year</span>(ymd), <span class="keyword">avg</span>(price_close) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    stocks</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">     <span class="keyword">exchange</span> = <span class="string">'nasdaq'</span> <span class="keyword">and</span> symbol = <span class="string">'aapl'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">year</span>(ymd)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">year</span>(ymd) <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--先对code进行排序，然后对code里的姓名进行排序</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">order</span> <span class="keyword">by</span> code, <span class="keyword">name</span> <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h2 id="having"><a href="#having" class="headerlink" title="having"></a>having</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- having 子句来限制输出结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- 查找平均工资大于3000的部门</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    deparment, <span class="keyword">avg</span>(salary) <span class="keyword">as</span> average </span><br><span class="line"><span class="keyword">from</span>  </span><br><span class="line">    salary_info </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    deparment </span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">    average &gt; <span class="number">3000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>having 与 where 的区别：<ul>
<li>Where 是一个约束声明，使用Where约束来自数据库的数据，Where是在结果返回之前起作用的，Where中不能使用聚合函数。</li>
<li>Having是一个过滤声明，是在查询返回结果集以后对查询结果进行的过滤操作，在Having中可以使用聚合函数。</li>
</ul>
</li>
</ul>
<h2 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---使用limit语句限制返回的行数，只显示 10 行</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">account</span>) <span class="keyword">as</span> uv  <span class="keyword">from</span>  employees  <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h2 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h2><h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>Hive中Join的关联键必须在ON ()中指定，不能在Where中指定,ON 子句指定了两个表间数据进行连接的条件。</p>
<p><img src="https://i.loli.net/2019/06/11/5cffb911ad8e183153.png" alt></p>
<ul>
<li>对于多张表进行连接查询<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---为什么条件内不将表 b 和表 c 进行连接操作， 因为 Hive总是按照从左到右的顺序来执行</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.ymd, a.price_close, b.price_close, c.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    a <span class="keyword">JOIN</span> b <span class="keyword">ON</span> a.ymd = b.ymd</span><br><span class="line">      <span class="keyword">JOIN</span> c <span class="keyword">ON</span> a.ymd = c.ymd</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    a. symbol = <span class="string">'Apple'</span>  <span class="keyword">AND</span> b.symbol = <span class="string">'Ibm'</span> <span class="keyword">AND</span> c.symbol = <span class="string">'Google'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="并集：union-与-union-all"><a href="#并集：union-与-union-all" class="headerlink" title="并集：union 与 union all"></a>并集：union 与 union all</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-02'</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> <span class="string">"%支付宝%"</span></span><br><span class="line">        <span class="keyword">union</span> </span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-02'</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> <span class="string">"%手淘%"</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>
<ul>
<li>union 与 union all 的不同：<ul>
<li>union, 结果包含所有行， 并删除重复行</li>
<li>unoin all, 结果包含所有行， 但不删除重复行</li>
</ul>
</li>
</ul>
<h3 id="交集：intersect"><a href="#交集：intersect" class="headerlink" title="交集：intersect"></a>交集：intersect</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-02'</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> <span class="string">"%支付宝%"</span></span><br><span class="line">        <span class="keyword">intersect</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-02'</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> <span class="string">"%手淘%"</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>
<h3 id="差集：except"><a href="#差集：except" class="headerlink" title="差集：except"></a>差集：except</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-25'</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> <span class="string">"%支付宝%"</span></span><br><span class="line">        <span class="keyword">except</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-25'</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> <span class="string">"%手淘%"</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>
<!-- https://wing324.github.io/2017/10/20/Hive%E5%AE%9E%E7%94%A8%E5%87%BD%E6%95%B0%E5%A4%A7%E5%85%A8/ -->
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>count()</td>
<td>个数统计函数</td>
</tr>
<tr>
<td>count(distinct  )</td>
<td>统计去重之后的个数</td>
</tr>
<tr>
<td>sum()</td>
<td>求和</td>
</tr>
<tr>
<td>sum(distinct )</td>
<td>去重之后的和</td>
</tr>
<tr>
<td>avg()</td>
<td>平均值</td>
</tr>
<tr>
<td>avg(distinct)</td>
<td>去重之后的平均值</td>
</tr>
<tr>
<td>min()</td>
<td>最小值</td>
</tr>
<tr>
<td>max()</td>
<td>最大值</td>
</tr>
<tr>
<td>corr(A, B)</td>
<td>相关系数</td>
</tr>
<tr>
<td>var_pop()</td>
<td>方差</td>
</tr>
<tr>
<td>var_samp()</td>
<td>样本方差</td>
</tr>
<tr>
<td>stddev_pop()</td>
<td>标准偏差</td>
</tr>
<tr>
<td>stddev_samp()</td>
<td>标准样本偏差</td>
</tr>
<tr>
<td>covar_pop(A, B)</td>
<td>协方差</td>
</tr>
<tr>
<td>covar_samp(A, B)</td>
<td>样本协方差</td>
</tr>
<tr>
<td>RAND()</td>
<td>随机数</td>
</tr>
</tbody>
</table>
<ul>
<li><p>count(1)、count(*)、count(column) 之间的区别</p>
<ul>
<li><p>执行效果上：<br>count(*)包括了所有的列，相当于行数，在统计结果的时候，不会忽略列值为NULL<br>count(1)包括了忽略所有列，用1代表代码行，在统计结果的时候，不会忽略列值为NULL<br>count(列名)只包括列名那一列，在统计结果的时候，会忽略列值为空（这里的空不是只空字符串或者0，而是表示null）的计数，即某个字段值为NULL时，不统计。</p>
</li>
<li><p>执行效率上：<br>列名为主键，count(列名)会比count(1)快<br>列名不为主键，count(1)会比count(列名)快<br>如果表多个列并且没有主键，则 count(1) 的执行效率优于count(*)<br>如果有主键，则 select count(主键)的执行效率是最优的<br>如果表只有一个字段，则 select count(*)最优。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="时间函数"><a href="#时间函数" class="headerlink" title="时间函数"></a>时间函数</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
<th>语句</th>
</tr>
</thead>
<tbody>
<tr>
<td>NOW ( )</td>
<td>当前时间</td>
<td>select now()</td>
</tr>
<tr>
<td>extract()</td>
<td>抽取具体的年、月、日</td>
</tr>
<tr>
<td>date()</td>
<td>返回时间的日期部分</td>
</tr>
<tr>
<td>year()</td>
<td>返回时间的年份</td>
</tr>
<tr>
<td>month()</td>
<td>返回时间的月份</td>
</tr>
<tr>
<td>day()</td>
<td>返回日期的天</td>
</tr>
<tr>
<td>hour()</td>
<td>返回时间的小时</td>
</tr>
<tr>
<td>minute()</td>
<td>返回时间的分钟</td>
</tr>
<tr>
<td>second()</td>
<td>返回时间的秒</td>
</tr>
<tr>
<td>week ()</td>
<td>第几周</td>
</tr>
<tr>
<td>dayofweek()</td>
<td>返回星期几，1为星期天</td>
</tr>
<tr>
<td>dayofyear()</td>
<td>一年中的第几天</td>
</tr>
<tr>
<td>sec_to_time ( )</td>
<td>秒数转成时间</td>
</tr>
<tr>
<td>date_add()</td>
<td>时间相加</td>
<td>date_add(dt,interval 1 day )</td>
</tr>
<tr>
<td>date_sub(date,INTERVAL expr（时间间隔） type（时间类型，天、月、年）)</td>
<td>时间相减</td>
<td>date_sub(‘2018-05-01’,interval -1 year)</td>
</tr>
<tr>
<td>datediff()</td>
<td>时间的差值</td>
</tr>
<tr>
<td>date_format()</td>
<td>输出指定时间格式</td>
<td>date_format(hit_date, “%Y-%m-%d)</td>
</tr>
<tr>
<td>datename()</td>
<td>返回日期部分的参数</td>
</tr>
<tr>
<td>datepart()</td>
<td>返回日期、时间的单独部分</td>
</tr>
</tbody>
</table>
<h3 id="求留存率"><a href="#求留存率" class="headerlink" title="求留存率"></a>求留存率</h3><ul>
<li><p>datediff-求留存率</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---一次性求次1日，次3日， 次7日留存，此方法不能计算pv，会造成笛卡尔积</span></span><br><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (<span class="keyword">select</span> </span><br><span class="line">    hit_date,</span><br><span class="line">    user_account</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    computer_view.data</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">'2019-04-25'</span> <span class="keyword">and</span> <span class="string">'2019-05-13'</span></span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    btn_information <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>),</span><br><span class="line">a2 <span class="keyword">as</span> (<span class="keyword">select</span> </span><br><span class="line">    hit_date,</span><br><span class="line">    user_account</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    computer_view.data</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">'2019-04-25'</span> <span class="keyword">and</span> <span class="string">'2019-05-13'</span></span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    btn_information <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">a1.hit_date,</span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> a1.user_account) uv,</span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">datediff</span>(a2.hit_date, a1.hit_date) = <span class="number">1</span> <span class="keyword">then</span> a1.user_account <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span> ) next_day,</span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">datediff</span>(a2.hit_date, a1.hit_date) = <span class="number">3</span> <span class="keyword">then</span> a1.user_account <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span> ) three_day,</span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">datediff</span>(a2.hit_date, a1.hit_date) = <span class="number">7</span> <span class="keyword">then</span> a1.user_account <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span> ) seven_day</span><br><span class="line"><span class="keyword">from</span> a1 <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.user_account = a2.user_account</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a1.hit_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a1.hit_date</span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>date_add 求留存率</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---步骤1：统计每天的uv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---步骤2： - 统计10-15号每天的次日留存数， 统计次3、7日留存只需将1换为3、7</span></span><br><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        user_account,</span><br><span class="line">        hit_date</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        computer_view.data</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        hit_date <span class="keyword">between</span>  <span class="string">'2018-11-10'</span> <span class="keyword">and</span> <span class="string">'2018-11-15'</span></span><br><span class="line">),</span><br><span class="line">a2 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">        user_account,</span><br><span class="line">        hit_date</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        computer_view.data</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        hit_date <span class="keyword">between</span> <span class="string">'2018-11-10'</span> <span class="keyword">and</span> <span class="string">'2018-11-25'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    a1.hit_date,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> a1.user_account) <span class="keyword">as</span> uv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1 <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.user_account = a2.user_account</span><br><span class="line"><span class="keyword">WHERE</span>   </span><br><span class="line">    a2.hit_date =  <span class="keyword">date_add</span>(a1.hit_date, <span class="number">1</span>) </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    a1.hit_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">BY</span></span><br><span class="line">    a1.hit_date</span><br><span class="line"></span><br><span class="line"><span class="comment">--步骤3：计算留存率</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>计算留存率的其他写法-迷神</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 留存sql优化</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span> userid, <span class="keyword">count</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">select</span> t1.userid,</span><br><span class="line">                t1.statdate</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            table1 t1</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            t1.statdate = $&#123;上<span class="number">30</span>天日期&#125;</span><br><span class="line">            <span class="keyword">and</span> t1.statdate &lt;= $&#123;上一天日期&#125;</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            t1.userid,</span><br><span class="line">            t1.statdate</span><br><span class="line">        ) s1</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        userid</span><br><span class="line">    <span class="keyword">having</span></span><br><span class="line">        <span class="keyword">count</span>(<span class="number">1</span>)  <span class="number">2</span></span><br><span class="line">    ) R1</span><br><span class="line"></span><br><span class="line"><span class="comment">--此sql为一个样例，计算连续跟任意都适用，至于计算第N天，只需要更改下日期过滤条件，变成=$[上N天日期]，=$&#123;上一天日期&#125;。 </span></span><br><span class="line"><span class="comment">--另外，这种方式适合跑当前周期数据，如果跑历史数据，可以写个循环。当然，最暴力还是直接用userid 关联。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--这种写法，更多是针对现在大部分分布式处理平台的特性，尽可能将数据合理均匀分片，每台服务器各自运算自己的，最后汇总。 尽可能少用 count distinct 这种写法，因为无法利用分片的特性。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>留存率的另一种写法-勇哥</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	hit_date,</span><br><span class="line">	user_account,</span><br><span class="line">	<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> hit_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	apache_computer_view.client_android_log</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">	hit_date <span class="keyword">between</span> <span class="string">'2020-04-01'</span> <span class="keyword">and</span>  <span class="string">'2020-04-07'</span></span><br><span class="line">	<span class="keyword">and</span></span><br><span class="line">	btn_navigation  <span class="keyword">like</span> <span class="string">"%查询办理%"</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">),</span><br><span class="line">a2 <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	hit_date,</span><br><span class="line">    user_account,</span><br><span class="line">    <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> hit_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	apache_computer_view.client_android_log</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	hit_date <span class="keyword">between</span> <span class="string">'2020-04-01'</span> <span class="keyword">and</span>  <span class="string">'2020-04-07'</span></span><br><span class="line">	<span class="keyword">and</span></span><br><span class="line">	btn_navigation  <span class="keyword">like</span> <span class="string">"%查询办理%"</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	a1.hit_date <span class="keyword">as</span> one,</span><br><span class="line">	a2.hit_date <span class="keyword">as</span> two,</span><br><span class="line">	<span class="keyword">datediff</span>(a2.hit_date, a1.hit_date) <span class="keyword">as</span> cha,</span><br><span class="line">	<span class="keyword">count</span>(<span class="keyword">distinct</span> a2.user_account),</span><br><span class="line">	<span class="keyword">sum</span>(a2.hit_count)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1 <span class="keyword">left</span> <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.user_account = a2.user_account</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    cha &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>计算月留存率的简单写法：筛选出在两个月份出现的用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (<span class="keyword">select</span> </span><br><span class="line">    user_account,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">month</span> (hit_date)) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    apache_computer_view.client_android_log </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     hit_date <span class="keyword">between</span> <span class="string">'2019-03-01'</span> <span class="keyword">and</span> <span class="string">'2019-04-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line"> user_account</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">  c = <span class="number">2</span></span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_account,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">month</span> (hit_date)) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    apache_computer_view.client_ios_log </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     hit_date <span class="keyword">between</span> <span class="string">'2019-03-01'</span> <span class="keyword">and</span> <span class="string">'2019-04-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line"> user_account</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">  c = <span class="number">2</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="条件判断：case-when-与-if"><a href="#条件判断：case-when-与-if" class="headerlink" title="条件判断：case when 与 if"></a>条件判断：case when 与 if</h2><ol>
<li><strong>IF( expr , v1 , v2 )函数</strong></li>
</ol>
<ul>
<li>查出班级所有学生，如果年龄小于20，就标准为少年，否则标记为青年。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    * </span><br><span class="line">     <span class="keyword">if</span>(age&lt;<span class="number">20</span>,<span class="string">'少年'</span>,<span class="string">'青年'</span>) <span class="keyword">AS</span> ifage </span><br><span class="line"><span class="keyword">from</span>  </span><br><span class="line">    student</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="2">
<li><strong>ifnull(V1,V2)函数</strong></li>
</ol>
<ul>
<li>如果v1不为空，则直接返回v1;如果v1为空，则返回参数v2<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">ifnull</span>(<span class="number">1</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">ifnull</span>(<span class="literal">null</span>,<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="3">
<li><strong>case when 函数</strong></li>
</ol>
<ul>
<li><p>对不同字母进行省份转换</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line"><span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'ah'</span> <span class="keyword">then</span> <span class="string">'安徽'</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'fj'</span> <span class="keyword">then</span> <span class="string">'福建'</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'gd'</span> <span class="keyword">then</span> <span class="string">'广东'</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">'m'</span> </span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> province ,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_account) uv,</span><br><span class="line">    <span class="keyword">count</span>(page_name) pv</span><br><span class="line"><span class="keyword">from</span> android_log</span><br><span class="line"><span class="keyword">where</span> hit_date <span class="keyword">between</span> <span class="string">'&#123;&#125;'</span> <span class="keyword">and</span> <span class="string">'&#123;&#125;'</span></span><br><span class="line"><span class="keyword">and</span> page_name <span class="keyword">like</span> <span class="string">'%Kefujh%'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'ah'</span> <span class="keyword">then</span> <span class="string">'安徽'</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'fj'</span> <span class="keyword">then</span> <span class="string">'福建'</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'gd'</span> <span class="keyword">then</span> <span class="string">'广东'</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">'m'</span> </span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'ah'</span> <span class="keyword">then</span> <span class="string">'安徽'</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'fj'</span> <span class="keyword">then</span> <span class="string">'福建'</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">'gd'</span> <span class="keyword">then</span> <span class="string">'广东'</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">'m'</span> </span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line"><span class="keyword">limit</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>统计各部门男女分别有多少人</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>姓名</th>
<th>部门</th>
<th>性别</th>
</tr>
</thead>
<tbody>
<tr>
<td>甲</td>
<td>A</td>
<td>男</td>
</tr>
<tr>
<td>乙</td>
<td>A</td>
<td>男</td>
</tr>
<tr>
<td>丙</td>
<td>B</td>
<td>女</td>
</tr>
<tr>
<td>丁</td>
<td>A</td>
<td>女</td>
</tr>
<tr>
<td>张</td>
<td>B</td>
<td>男</td>
</tr>
<tr>
<td>赵</td>
<td>B</td>
<td>女</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    部门，</span><br><span class="line">    <span class="keyword">sum</span> (<span class="keyword">case</span> 性别 <span class="keyword">when</span> <span class="string">'男'</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> male_count,</span><br><span class="line">    <span class="keyword">sum</span> (<span class="keyword">case</span> 性别 <span class="keyword">when</span> <span class="string">'女'</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> male_count</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    table1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> 部门</span><br></pre></td></tr></table></figure>
<ul>
<li>范围转换<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">case</span> <span class="keyword">when</span> population &lt; <span class="number">250</span> <span class="keyword">then</span> <span class="string">'1'</span></span><br><span class="line">            <span class="keyword">when</span> population = <span class="number">250</span> <span class="keyword">and</span> population &lt; <span class="number">500</span> <span class="keyword">then</span> <span class="string">'2'</span></span><br><span class="line">            <span class="keyword">when</span> population = <span class="number">500</span> <span class="keyword">and</span> population &lt; <span class="number">750</span> <span class="keyword">then</span> <span class="string">'3'</span></span><br><span class="line">            <span class="keyword">when</span> population = <span class="number">750</span> <span class="keyword">then</span> <span class="string">'4'</span></span><br><span class="line">        <span class="keyword">else</span> <span class="literal">null</span> <span class="keyword">end</span> <span class="keyword">as</span> pop_classs,</span><br><span class="line">        <span class="keyword">count</span>(*) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    pop</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    district;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="行转列"><a href="#行转列" class="headerlink" title="行转列"></a>行转列</h2><ol>
<li>函数</li>
</ol>
<ul>
<li><strong>case when</strong></li>
<li><strong>concat</strong>(string A/col, string B/col…) ：函数在连接字符串时，只要其中一个是NUll，则返回NUll</li>
<li><strong>concat_ws</strong>(separator, str1, str2,…): 函数需要指定分隔符，只能接收 string或string类型的数组，只要有一个字符串不是NUll， 则不会返回NULL。</li>
<li><strong>collect_set</strong>(col): 函数值接受基本数据类型，主要作用是将某字段的值进行去重汇总，产生array类型字段。</li>
</ul>
<ol start="2">
<li>案例</li>
</ol>
<ul>
<li>多行转多列</li>
</ul>
<table>
<thead>
<tr>
<th>年</th>
<th>季度</th>
<th>销售量</th>
</tr>
</thead>
<tbody>
<tr>
<td>1991</td>
<td>1</td>
<td>11</td>
</tr>
<tr>
<td>1991</td>
<td>2</td>
<td>12</td>
</tr>
<tr>
<td>1991</td>
<td>3</td>
<td>13</td>
</tr>
<tr>
<td>1991</td>
<td>4</td>
<td>14</td>
</tr>
<tr>
<td>1992</td>
<td>1</td>
<td>21</td>
</tr>
<tr>
<td>1992</td>
<td>2</td>
<td>22</td>
</tr>
<tr>
<td>1992</td>
<td>3</td>
<td>23</td>
</tr>
<tr>
<td>1992</td>
<td>4</td>
<td>24</td>
</tr>
</tbody>
</table>
<p>查询结果如下：</p>
<table>
<thead>
<tr>
<th>年</th>
<th>一季度</th>
<th>二季度</th>
<th>三季度</th>
<th>四季度</th>
</tr>
</thead>
<tbody>
<tr>
<td>1991</td>
<td>11</td>
<td>12</td>
<td>13</td>
<td>14</td>
</tr>
<tr>
<td>1992</td>
<td>21</td>
<td>22</td>
<td>23</td>
<td>24</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    年,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> 季度=<span class="number">1</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> 一季度,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> 季度=<span class="number">2</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> 二季度,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> 季度=<span class="number">3</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> 三季度,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> 季度=<span class="number">4</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> 四季度,</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    年</span><br></pre></td></tr></table></figure>
<ul>
<li>多行转单列</li>
</ul>
<table>
<thead>
<tr>
<th>省-城市</th>
<th>uv</th>
</tr>
</thead>
<tbody>
<tr>
<td>河北省-保定</td>
<td>11189</td>
</tr>
<tr>
<td>山西省-阳泉市</td>
<td>13</td>
</tr>
<tr>
<td>河南省-信阳</td>
<td>7462</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="keyword">concat</span>(province,<span class="string">'-'</span>, city), uv </span><br><span class="line"><span class="comment">--concat_ws('-', province, city), uv </span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> </span><br><span class="line">    province, </span><br><span class="line">    city,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">apache_computer_view</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date = <span class="string">'2020-03-01'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">province, city)</span><br></pre></td></tr></table></figure>
<ul>
<li>多行转单列-复杂</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>contellation</th>
<th>blood_type</th>
</tr>
</thead>
<tbody>
<tr>
<td>孙悟空</td>
<td>白羊座</td>
<td>A</td>
</tr>
<tr>
<td>猪八戒</td>
<td>射手座</td>
<td>A</td>
</tr>
<tr>
<td>宋宋</td>
<td>白羊座</td>
<td>B</td>
</tr>
<tr>
<td>唐僧</td>
<td>白羊座</td>
<td>A</td>
</tr>
<tr>
<td>张帅</td>
<td>射手座</td>
<td>A</td>
</tr>
</tbody>
</table>
<p>把星座和血型一样的人归类到一起：</p>
<table>
<thead>
<tr>
<th>。。。</th>
<th>。。。</th>
</tr>
</thead>
<tbody>
<tr>
<td>射手座,A</td>
<td>猪八戒\张帅</td>
</tr>
<tr>
<td>白羊座，A</td>
<td>孙悟空\唐僧</td>
</tr>
<tr>
<td>白羊座，B</td>
<td>宋</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"> t1.c_b</span><br><span class="line"> <span class="keyword">concat_ws</span>(<span class="string">"\", collect_set (t1.name))</span></span><br><span class="line"><span class="string">from (</span></span><br><span class="line"><span class="string">    select </span></span><br><span class="line"><span class="string">        concat_ws(',', constellation, blood_type) c_b,</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">    from </span></span><br><span class="line"><span class="string">        person_info) t1</span></span><br><span class="line"><span class="string">group by </span></span><br><span class="line"><span class="string">    t1.c_b;</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>求将每个省的城市列出来</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    province, </span><br><span class="line">    collect_set(city)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">apache_computer_view.client_android_log </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date = <span class="string">'2020-03-01'</span></span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line">nbtn_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">province</span><br><span class="line"></span><br><span class="line"><span class="comment">---辽宁省	["营口市","大连","大连市","抚顺市","铁岭","盘锦","锦州","沈阳市","辽阳","鞍山","铁岭市","本溪市","丹东市","丹东","沈阳","朝阳市","锦州市","辽阳市","阜新市","鞍山市","盘锦市","葫芦岛","营口","抚顺","葫芦岛市","阜新","本溪","朝阳"]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>求出一个月内活跃天数大于20天的用户数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--先列出每个用户的所有登陆时间</span></span><br><span class="line"><span class="comment">--选出需要的时间段</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> </span><br><span class="line">        user_account,</span><br><span class="line">        collect_set(hit_date) <span class="keyword">as</span> t</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        apache_computer_view.client_android_log </span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        hit_date <span class="keyword">between</span> <span class="string">'2020-03-01'</span> <span class="keyword">and</span> <span class="string">'2020-03-31'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">        user_account) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">size</span>(a.t) &gt;= <span class="number">20</span></span><br><span class="line"><span class="comment">--手机号对应日期长度 &gt;= 20</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="列转行"><a href="#列转行" class="headerlink" title="列转行"></a>列转行</h2><ol>
<li>函数</li>
</ol>
<ul>
<li><p>explode(col): 将hive列中复杂的array或者map结构拆分成多行</p>
</li>
<li><p><strong>lateral view</strong><br>用法： lateral view udtf(expression) tableAlias as columnAlias<br>说明： 用户和split,explode 等UDTF一起使用，能够将一列数据拆分成多行数据， 在此基础上可以对拆分的数据进行聚合计算.   形成一个新的表，并对原来的表进行侧写</p>
</li>
</ul>
<ol start="2">
<li>案例</li>
</ol>
<ul>
<li>需求1</li>
</ul>
<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody>
<tr>
<td>《疑犯追踪》</td>
<td>悬疑,动作,科幻,剧情</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>警匪,动作,心理</td>
</tr>
</tbody>
</table>
<p>要求：</p>
<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody>
<tr>
<td>《疑犯追踪》</td>
<td>悬疑</td>
</tr>
<tr>
<td>《疑犯追踪》</td>
<td>动作</td>
</tr>
<tr>
<td>《疑犯追踪》</td>
<td>科幻</td>
</tr>
<tr>
<td>《疑犯追踪》</td>
<td>剧情</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>警匪</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>动作</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>心理</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    movie,</span><br><span class="line">    category_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    movie_info</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">category</span>) tmpTable  <span class="keyword">as</span> category_name</span><br><span class="line"></span><br><span class="line"><span class="comment">---用分开的表，对要求的数据进行测写</span></span><br><span class="line"><span class="comment">-- select movie,explode(category) from movie_info 会生成笛卡尔积，不能执行</span></span><br></pre></td></tr></table></figure>
<ul>
<li>需求2： 将 表 table 中的 <code>adid_list</code> 转换为单独的行。 </li>
</ul>
<p>表-table：</p>
<table>
<thead>
<tr>
<th>pageid</th>
<th>adid_list</th>
</tr>
</thead>
<tbody>
<tr>
<td>front_page</td>
<td>[1,2,3]</td>
</tr>
<tr>
<td>contact_page</td>
<td>[3,4]</td>
</tr>
</tbody>
</table>
<p> 输出结果为： </p>
<table>
<thead>
<tr>
<th>pageid</th>
<th>adid_list</th>
</tr>
</thead>
<tbody>
<tr>
<td>front_page</td>
<td>1</td>
</tr>
<tr>
<td>front_page</td>
<td>2</td>
</tr>
<tr>
<td>front_page</td>
<td>3</td>
</tr>
<tr>
<td>contact_page</td>
<td>3</td>
</tr>
<tr>
<td>contact_page</td>
<td>4</td>
</tr>
</tbody>
</table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    pageid, adid</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="keyword">table</span></span><br><span class="line"><span class="keyword">lateral</span>  <span class="keyword">view</span> <span class="keyword">explode</span>(adid_list) adTable  <span class="keyword">as</span> adid</span><br></pre></td></tr></table></figure>
<ul>
<li><p>需求3： 计算特定广告的展现次数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    adid, <span class="keyword">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="keyword">table</span></span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(adid_list) adTable <span class="keyword">as</span> adid</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    adid</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输出结果为： </p>
<table>
<thead>
<tr>
<th>adid</th>
<th>count(1)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li>需求4： 多个 lateral view 查询</li>
</ul>
<p>表： table2</p>
<table>
<thead>
<tr>
<th>array</th>
<th>col2</th>
</tr>
</thead>
<tbody>
<tr>
<td>[1,2]</td>
<td>[“a”，”b”]</td>
</tr>
<tr>
<td>[3,4]</td>
<td>[“c”, “d”]</td>
</tr>
</tbody>
</table>
<p>输出结果为： </p>
<table>
<thead>
<tr>
<th>myCol1</th>
<th>myCol2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“a”</td>
</tr>
<tr>
<td>1</td>
<td>“b”</td>
</tr>
<tr>
<td>2</td>
<td>“a”</td>
</tr>
<tr>
<td>2</td>
<td>“b”</td>
</tr>
<tr>
<td>3</td>
<td>“c”</td>
</tr>
<tr>
<td>3</td>
<td>“d”</td>
</tr>
<tr>
<td>4</td>
<td>“c”</td>
</tr>
<tr>
<td>4</td>
<td>“d”</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    myCol1, myCol2</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    baseTable</span><br><span class="line"><span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> <span class="keyword">explode</span>(col1) myTable1 <span class="keyword">AS</span> myCol1</span><br><span class="line"><span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> <span class="keyword">explode</span>(col2) myTable2 <span class="keyword">AS</span> myCol2</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><ol>
<li>函数 </li>
</ol>
<table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>over()</td>
<td>指定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变化而变化</td>
</tr>
<tr>
<td><strong>常跟的函数</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>current row</td>
<td>当前行</td>
</tr>
<tr>
<td>n preceding</td>
<td>往前n行数据</td>
</tr>
<tr>
<td>n following</td>
<td>往后n行数据</td>
</tr>
<tr>
<td>unbounded</td>
<td>起点</td>
</tr>
<tr>
<td>uvbounded preceding</td>
<td>表示从前面的起点开始</td>
</tr>
<tr>
<td>unbounded following</td>
<td>表示到后面的终点</td>
</tr>
<tr>
<td>lag(col, n)</td>
<td>往前第n行数据</td>
</tr>
<tr>
<td>lead(col, n)</td>
<td>往后第n行数据</td>
</tr>
<tr>
<td>ntile(n)</td>
<td>把有序分区中的行分发到指定数据的组中， 各个组有编号，编号从1开始，ntile返回此行所属组的编号</td>
</tr>
<tr>
<td>first_value()</td>
<td>返回组中数据窗口的第一个值</td>
</tr>
<tr>
<td>last_value()</td>
<td>返回组中数据窗口的最后一个值</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>案例</li>
</ol>
<table>
<thead>
<tr>
<th>name</th>
<th>orderdate</th>
<th>cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>jack</td>
<td>2017-01-01</td>
<td>10</td>
</tr>
<tr>
<td>tony</td>
<td>2017-01-02</td>
<td>15</td>
</tr>
<tr>
<td>jack</td>
<td>2017-01-03</td>
<td>23</td>
</tr>
<tr>
<td>tony</td>
<td>2017-01-04</td>
<td>29</td>
</tr>
<tr>
<td>jack</td>
<td>2017-01-05</td>
<td>46</td>
</tr>
<tr>
<td>jack</td>
<td>2017-04-06</td>
<td>42</td>
</tr>
<tr>
<td>tony</td>
<td>2017-01-07</td>
<td>50</td>
</tr>
<tr>
<td>jack</td>
<td>2017-01-08</td>
<td>55</td>
</tr>
<tr>
<td>mart</td>
<td>2017-04-08</td>
<td>62</td>
</tr>
<tr>
<td>mart</td>
<td>2017-04-09</td>
<td>68</td>
</tr>
<tr>
<td>neil</td>
<td>2017-05-10</td>
<td>12</td>
</tr>
<tr>
<td>mart</td>
<td>2017-04-11</td>
<td>75</td>
</tr>
<tr>
<td>neil</td>
<td>2017-06-12</td>
<td>80</td>
</tr>
<tr>
<td>mart</td>
<td>2017-04-13</td>
<td>94</td>
</tr>
</tbody>
</table>
<ul>
<li>查询在2017年4月购买的顾客及总人数<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">     <span class="keyword">name</span>,<span class="keyword">count</span>(<span class="number">1</span>)<span class="keyword">over</span>() <span class="comment">----over全量， 如果不加over，就会按照name来划分</span></span><br><span class="line"><span class="keyword">from</span>    </span><br><span class="line">    business</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    substring_index(orderdate,<span class="string">'-'</span>,<span class="number">2</span>) = <span class="string">'2017-04'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">name</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>c1</th>
<th>不加over</th>
</tr>
</thead>
<tbody>
<tr>
<td>jack</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>mart</td>
<td>2</td>
<td>4</td>
</tr>
</tbody>
</table>
<ul>
<li><p>查询顾客的购买明细及月购买总额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span> (<span class="keyword">distribute</span> <span class="keyword">by</span> <span class="keyword">month</span>(orderdate))</span><br><span class="line"><span class="comment">--- sum(cost) over (partition by month(orderdate))</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
</li>
<li><p>要将cost按照日期进行累加</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照日期进行排序，并将当前日期和前一天、后一天数据求和</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">following</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
</li>
<li><p>求每个人将按照日期进行累加的消费金额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">unbounded</span> <span class="keyword">preceding</span> <span class="keyword">and</span> <span class="keyword">current</span> <span class="keyword">row</span> )</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
</li>
<li><p>要将cost按照日期进行倒序累加</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span>  orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">current</span> <span class="keyword">now</span> <span class="keyword">and</span> <span class="keyword">unbounded</span> <span class="keyword">following</span> )</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询顾客上次购买的时间, 与下次购买时间。相邻两个时间戳如何相减，求时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    *,</span><br><span class="line">    lag(orderdate, <span class="number">1</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate),</span><br><span class="line">    <span class="keyword">lead</span>(orderdate,<span class="number">1</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询前20%时间的订单信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    * </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">            <span class="keyword">name</span>, orderdate, <span class="keyword">cost</span>, ntile(<span class="number">5</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate) gid</span><br><span class="line">        <span class="keyword">from</span> </span><br><span class="line">            business</span><br><span class="line">    ) t</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    git =<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><a href="https://www.cnblogs.com/52xf/p/4209211.html" target="_blank" rel="noopener">ntile函数详解</a></strong><br>ntile函数可以将有序数据，根据指定的组数进行分组处理。 编号从1开始，对于每一行，ntile将返回此行所属的组编号。<br>ntile函数的分组依据：</p>
<ul>
<li>每组包含的数据个数不能大于它上一组 包含的数据个数</li>
<li>计算规则：1. 检查能不能对所有满足条件的记录进行平均分组，若能则直接平均分配完成分组。2. 若不能，则会先分出一个组，此组个数为（总个数/总组数）+1。3. 分配之后系统会继续比较余下的记录数与未分配的组数能不能进行平均分配，若不能，则根据上面条件再分配。</li>
<li>例如：将6个记录分为4组， 不能平均分配则，第一组记录数为 （6/4)+1 = 2条记录。剩余4条记录分为3组，不能平均分配，则第二组记录数为（4/3)+1=2条记录。剩余2条记录分为2组，则剩余2组各1条记录。 </li>
</ul>
</li>
</ul>
<h2 id="排序函数"><a href="#排序函数" class="headerlink" title="排序函数"></a>排序函数</h2><ol>
<li>函数 </li>
</ol>
<p>SQl 中用于排序的函数有：rank、dense_rank、row_number、ntile函数,其语法为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rank() over ([partition by A] order by B  DESC)</span><br><span class="line"></span><br><span class="line">dense_rank() over ([partition by A] order by B DESC)</span><br><span class="line"></span><br><span class="line">row_number() over ([partition by A] order by B DESC )</span><br><span class="line"></span><br><span class="line">ntile() over([partition by A] order by B desc)</span><br><span class="line"><span class="comment">-- partition by A 表示 按照A进行分区。</span></span><br><span class="line"><span class="comment">-- order by B 表示按照B进行排序。</span></span><br><span class="line"><span class="comment">-- DESC 表示 从大到小降序排列。</span></span><br><span class="line"><span class="comment">-- 其中[partition by col1]若不需要则可省略不写。</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>明确各函数之间的不同点</strong><br>rank函数， 数值相等的排序则会留下空位： 1、2、2、4<br>dense_rank函数，数值相等的排序不会留下空位: 1、2、2、3<br>row_number函数，则不区分数值是否相等，默认排序为： 1、2、3、4<br>ntile函数，对有序行进行分组处理</li>
</ul>
<p>**2.需求</p>
<ul>
<li><p>如何找出各省点击人数Top10的按钮？</p>
<p>对于这个问题，首先要理清自己的思路：1. 取出 省份、按钮和 uv;2. 各省分组内，按照uv进行从大到小排序，并输出一列排序序号;3. 根据排序序号，取出排序前10的按钮和省份。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    province, </span><br><span class="line">    nbtn_name </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    province,  <span class="comment">--省份</span></span><br><span class="line">    nbtn_name, <span class="comment">--按钮 </span></span><br><span class="line">    uv,        <span class="comment">--uv</span></span><br><span class="line">    <span class="keyword">dense_rank</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> province <span class="keyword">order</span> <span class="keyword">by</span> uv <span class="keyword">DESC</span>) <span class="keyword">as</span> ran <span class="comment">--排序</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    province,</span><br><span class="line">    nbtn_name,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    apache_computer_view.client_android_log </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    nbtn_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>  </span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    hit_date = <span class="string">'2020-03-10'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    province,</span><br><span class="line">    nbtn_name))</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    ran &lt;= <span class="number">10</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>求连续4个月活跃的用户数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---1月活跃的用户数， 在2月、3月、4月一直活跃的用户有多少？</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span>  user_account , <span class="keyword">month</span>(hit_date) <span class="keyword">as</span> <span class="keyword">month</span></span><br><span class="line"><span class="keyword">from</span> compu_view.ios_log_view</span><br><span class="line"><span class="keyword">where</span> hit_date <span class="keyword">between</span> <span class="string">'2019-01-01'</span> <span class="keyword">and</span> <span class="string">'2019-04-30'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_account, <span class="keyword">month</span>(hit_date) </span><br><span class="line">),</span><br><span class="line">a2 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">    user_account,a1.month,</span><br><span class="line">    row_number() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span>  user_account <span class="keyword">order</span> <span class="keyword">by</span> a1.month) <span class="keyword">as</span> px</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br><span class="line">)</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a2</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    a2.px = <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="3">
<li>求4月连续7天进行签到的用户数</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h2><ol>
<li>函数</li>
</ol>
<table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>concat()</td>
<td>拼接字符串</td>
</tr>
<tr>
<td>length()</td>
<td>计算字符串的长度，一个汉字算三个字符</td>
</tr>
<tr>
<td>instr (A ,B )</td>
<td>返回字符B首次在A中出现的位置,不存在返回0</td>
</tr>
<tr>
<td>lcase()</td>
<td>转换成小写</td>
</tr>
<tr>
<td>left(string2 ,length )</td>
<td>从string2中的左边起取length个字符</td>
</tr>
<tr>
<td>lower()</td>
<td>将字串转化为小写</td>
</tr>
<tr>
<td>upper()</td>
<td>将字符转化为大写</td>
</tr>
<tr>
<td>replace()</td>
<td>替换字符</td>
</tr>
<tr>
<td>split()</td>
<td>hive字符串分割函数</td>
</tr>
<tr>
<td>substr()</td>
<td>返回字符串A从start位置开始，长度为len的字符串</td>
</tr>
<tr>
<td>substring()</td>
<td>截取字符串</td>
</tr>
<tr>
<td>substring_index()</td>
<td>通过截取获取不同索引位的字符</td>
</tr>
<tr>
<td>LTRIM (string2 )</td>
<td>去除前端空格</td>
</tr>
<tr>
<td>RTRIM (string2 )</td>
<td>去除后端空格</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>函数详解</li>
</ol>
<p><strong>substr函数与 substring函数用法相同:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substr/substring( A, k开始截取的位置，截取长度)</span><br></pre></td></tr></table></figure>
<p>举例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">substr(string,4): 从右第4位置截取到最后，结果为：ing</span><br><span class="line">substr(string,1,3):取左边第1位置起，3字长的字符串，结果为：str</span><br><span class="line">substr(string,-3,3):取右边第1位置起，3字长的字符串,右边第一位置往右不够3字长，结果为：g</span><br><span class="line">substr(string,-3,3):取右边第1位置起，3字长的字符串，结果为：ing</span><br></pre></td></tr></table></figure></p>
<p><strong>substring_index函数</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substring_index(A, 分割的字符,截取字符的位置)</span><br></pre></td></tr></table></figure></p>
<p>举例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">substring_index(&apos;15,151,152,16&apos;,&apos;,&apos;,1)：取第一个逗号前面的字符串，结果为：15</span><br><span class="line"></span><br><span class="line">substring_index(&apos;15,151,152,16&apos;,&apos;,&apos;,2)：取第二个逗号前面部分，结果为：15,151</span><br><span class="line"></span><br><span class="line">substring_index(&apos;15,151,152,16&apos;,&apos;,&apos;,-1)：取目标字符串中最后一个含 “,” 位子的后的部分，结果为：16</span><br><span class="line"></span><br><span class="line">substring_index(substring_index(&apos;15,151,152,16&apos;,&apos;,&apos;,2),&apos;,&apos;,-1):取第二个逗号前面部分,然后最后逗号的前面部分，结果为：151</span><br><span class="line"></span><br><span class="line">substring_index(substring_index(&apos;15,151,152,16&apos;,&apos;,&apos;,-2),&apos;,&apos;,1)：取倒数第二个逗号后面部分字符串，再去这部分里第一个都号前的部分，结果为：152</span><br></pre></td></tr></table></figure></p>
<p><strong>split函数</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">split(A, 分割的字符)</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">split(&apos;a,b,c,d&apos;,&apos;,&apos;):根据逗号进行分割，结果为： [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;]</span><br><span class="line"></span><br><span class="line">split(&apos;a,b,c,d&apos;,&apos;,&apos;)[0]： 取结果数组中的某一项，结果为： a</span><br><span class="line"></span><br><span class="line">split(&apos;192.168.0.1&apos;,&apos;\\.&apos;)： 点号这种特殊字符的时候需要做特殊的处理，结果为：[&quot;192&quot;,&quot;168&quot;,&quot;0&quot;,&quot;1&quot;]</span><br><span class="line"></span><br><span class="line">&quot;....  split(&apos;192.168.0.1&apos;,&apos;\\\\.&apos;) ... &quot;: split包含在 &quot;&quot; 之中时 需要加4个\,不然得到的值是null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">同样的 | 等特殊符号也需要做类似 处理。</span><br></pre></td></tr></table></figure>
<p>3.区分函数之前的区别</p>
<ul>
<li>substr函数与 substring函数是根据截取的位置来进行分割。</li>
<li>substring_index和split是根据特定的字符来进行分割。</li>
</ul>
<ol start="4">
<li>需求 </li>
</ol>
<ul>
<li>将一些字段拆解出来进行使用，比如：Syjh-sjsy-zygn-3_1字段，我们只需要Syjh-sjsy-zygn位置的所有按钮。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">    substring_index(nbtn_position, &apos;-&apos;,3) as position,</span><br><span class="line">    count(distinct user_account) as uv </span><br><span class="line">from </span><br><span class="line">    apache_computer_view</span><br><span class="line">where </span><br><span class="line">    hit_date = &apos;2020-03-01&apos;</span><br><span class="line">    and </span><br><span class="line">    nbtn_position like &apos;%Syjh%&apos;</span><br><span class="line">group by </span><br><span class="line">    substring_index(nbtn_position, &apos;-&apos;,3)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="空字段赋值"><a href="#空字段赋值" class="headerlink" title="空字段赋值"></a>空字段赋值</h2><p>NVL：给值为NULL的数据赋值，格式为NVL（string1, replace_with),功能为：如果string1为null，则NVL函数返回replace_with的值，否则返回string1的值，如果两个参数都为NULL，则返回NULL。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> nvl(comm, <span class="number">-1</span>) <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure></p>
<h2 id="查看系统内置函数"><a href="#查看系统内置函数" class="headerlink" title="查看系统内置函数"></a>查看系统内置函数</h2><ol>
<li><p>查看系统自带的函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> functions</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示自带的函数的用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc function 函数名;</span><br></pre></td></tr></table></figure>
</li>
<li><p>详细显示自带的函数用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc function extended 函数名</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="Hive避免数据倾斜"><a href="#Hive避免数据倾斜" class="headerlink" title="Hive避免数据倾斜"></a>Hive避免数据倾斜</h1><ul>
<li><p>数据倾斜：当我们在Hive上进行查询时，因为数据的分散度不够， 导致大量数据集中在一台或者几台服务器上， 导致数据的计算速度远远低于平均计算速度， 计算过程特别耗时。</p>
</li>
<li><p>数据倾斜的表现：任务进度长时间维持在99%，查看任务监控页面，发现只有少量子任务未完成。</p>
</li>
</ul>
<h2 id="小表Join大表"><a href="#小表Join大表" class="headerlink" title="小表Join大表"></a>小表Join大表</h2><ul>
<li><p>Hive 会假定查询中最后一个表是最大的表， 在对每行记录进行连续操作时， 它会尝试将其他表缓存起来，然后扫描最后那个表进行计算。因此，我们在查询时，要保证连续查询中的表的大小从左到右依次是增加的。  </p>
</li>
<li><p>假如，在 a, b 两个表中，b表最小， 则 写sql时需让b表在左，a表在右：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    b <span class="keyword">JOIN</span> a <span class="keyword">ON</span> b.ymd = a.ymd <span class="keyword">AND</span> b.symbol = a.symbol</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.symbol = <span class="string">'APPLE'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">---Hive支持使用/*+STREAMTALBE*/语法指定哪张表是大表， 不需要排序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="comment">/*+3`'LKLLGFG Streamtable(a)*/</span> a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    a <span class="keyword">JOIN</span> B <span class="keyword">on</span> a.ymd = b.ymd <span class="keyword">AND</span> a.symbol = b.symbol</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.symbol = <span class="string">'Apple'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="大表JOIN大表"><a href="#大表JOIN大表" class="headerlink" title="大表JOIN大表"></a>大表JOIN大表</h2><ol>
<li><p>空key过滤<br>有时join超时是因为某些key对应的数据太多，而相同key对应的数据都会发送到相同的reducer上，从而导致内存不够。此时我们应该仔细分析这些异常的key，很多情况下，这些key对应的数据是异常数据，我们需要在sql语句中进行过滤。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">From</span> </span><br><span class="line">    a <span class="keyword">Join</span>  b</span><br><span class="line"><span class="keyword">On</span></span><br><span class="line">     a.user_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">And</span> </span><br><span class="line">    a.user_id = b.user_id</span><br><span class="line"><span class="keyword">Union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">Select</span></span><br><span class="line">    * </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    a.user_id <span class="keyword">is</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>空key转换<br>有时虽然某个key为空对应的数据很多，但是相应的数据不是异常数据，必须要包含在join的结果中，此时我们可以表a中key为空的字段赋一个随机值，是的数据随机均匀地分布到不同的reducer上。 </p>
<ul>
<li>把空值的 key 变成一个字符串加上随机数，就能把倾斜的数据分到不同的 reduce 上 ,解决数据倾斜问题。</li>
<li>需要用到Case When … Else…End语法<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> n.*</span><br><span class="line"><span class="keyword">from</span>  nullidtable n <span class="keyword">full</span> <span class="keyword">join</span> bigtable o <span class="keyword">on</span></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> n.id <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="keyword">concat</span>(<span class="string">'hive'</span>, <span class="keyword">rand</span>()) <span class="keyword">else</span> n.id <span class="keyword">end</span>  = o.id;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h2 id="count-distinct-去重统计"><a href="#count-distinct-去重统计" class="headerlink" title="count(distinct) 去重统计"></a>count(distinct) 去重统计</h2><ul>
<li>数据量大时，由于count distinct 操作需要用一个 reduce task 来完成， 这一个reduce 需要处理的数据量太大，会导致整个job很难完成，一般 count distinct 使用先group by 再 count的方式替换。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">id</span>) <span class="keyword">from</span> bigtable</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> bigtable <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>) a</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="避免笛卡尔积"><a href="#避免笛卡尔积" class="headerlink" title="避免笛卡尔积"></a>避免笛卡尔积</h2><p>尽量避免产生笛卡尔积，如join时不加on条件，或无效的on条件。hive只能使用1个reducer来完成笛卡尔积</p>
<h2 id="行列过滤"><a href="#行列过滤" class="headerlink" title="行列过滤"></a>行列过滤</h2><ol>
<li><p>列处理： 在查询中， 避免使用 select *, 使用条件限制取需要的列。</p>
</li>
<li><p>行处理： 在分区剪裁中，当使用join外关联时，如果将副表的过滤条件写在where后面，那么就会先全表关联，之后再过滤, 这样会耗费资源。</p>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o.id <span class="keyword">from</span> bigtable b </span><br><span class="line"><span class="keyword">join</span> ori o on.id = b.id </span><br><span class="line"><span class="keyword">where</span> o.id &lt;=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> b.id <span class="keyword">from</span> bigtable b</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> ori <span class="keyword">where</span> <span class="keyword">id</span> &lt;=<span class="number">10</span>) o <span class="keyword">on</span> b.id = o.id)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    b <span class="keyword">JOIN</span> a <span class="keyword">ON</span> b.ymd = a.ymd <span class="keyword">AND</span> b.symbol = a.symbol</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    s.symbol = <span class="string">'APPLE'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--正确的写法是将 where 条件写在 on 后面</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    b <span class="keyword">JOIN</span> a <span class="keyword">ON</span> ( b.ymd = a.ymd <span class="keyword">AND</span> b.symbol = a.symbol <span class="keyword">and</span> s.symbol = <span class="string">'APPLE'</span></span><br></pre></td></tr></table></figure>
<h2 id="union-all-子查询避免中使用-group-by等"><a href="#union-all-子查询避免中使用-group-by等" class="headerlink" title="union all 子查询避免中使用 group by等"></a>union all 子查询避免中使用 group by等</h2><ul>
<li>union all 子查询避免中使用 group by【替换 count(distinct) 除外】、count(distinct)、max、min等。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account,</span><br><span class="line">            hit_date</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-13'</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> <span class="string">"%支付宝%"</span></span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account,</span><br><span class="line">            hit_date</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            <span class="keyword">data</span></span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">'2018-12-01'</span> <span class="keyword">and</span> <span class="string">'2018-12-13'</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> <span class="string">"%支付宝%"</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    hit_date,</span><br><span class="line">    <span class="keyword">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    hit_date</span><br></pre></td></tr></table></figure>
<h2 id="避免不同数据类型进行关联"><a href="#避免不同数据类型进行关联" class="headerlink" title="避免不同数据类型进行关联"></a>避免不同数据类型进行关联</h2><ul>
<li>使用CAST函数对数据类型进行转换，语法为cast(value AS TYPE)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">    a.price_close,</span><br><span class="line">    b.price_close</span><br><span class="line">from</span><br><span class="line">    a join b  on a.user_id = cast(b.user_id as string)</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-11-01&apos; and &apos;2018-11-02&apos;</span><br><span class="line">    and </span><br><span class="line">    a.symbol = &apos;apple&apos;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Hive的查询注意事项以及优化总结：</p>
<ol>
<li><p>尽量尽早过滤数据，减少每个阶段的数据量。对于分区表要加分区，同时只选择需要使用到的字段</p>
</li>
<li><p>对历史库的计算经验</p>
</li>
<li><p>尽量原子化操作，尽量避免一个SQL包含复杂逻辑，可以使用中间表来完成复杂的逻辑</p>
</li>
<li><p>join操作 小表要注意放在join的左边，否则会引起磁盘和内存的大量消耗</p>
</li>
<li><p>如果union all的部分个数大于2，或者每个union部分数据量大，应该拆成多个insert into语句，实际测试过程中，执行时间能提升50%</p>
</li>
</ol>
<h1 id="用python脚本连接数据库"><a href="#用python脚本连接数据库" class="headerlink" title="用python脚本连接数据库"></a>用python脚本连接数据库</h1><p>作为一名数据分析师，日报、周报、月报数据一个也不能少。 相应的， 就要在数据库中提取大量的数据， 并处理大量的Excel表格。 </p>
<p>在提取和处理数据的过程中， 对于一些重复性的劳动， 写个Python脚本来实现半自动化， 能够大幅提高自己的工作效率。 以下是自己工作中的一点总结经验。</p>
<ol>
<li><p>首先， 用Python连接数据库</p>
<p>对于数据库的ip地址，用户名，密码等， 如果不清楚，或数据库连接不上， 需要和开发人员对接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyhive <span class="keyword">import</span> hive </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">conn = hive.Connection(host=<span class="string">'ip地址'</span>, port=<span class="number">10000</span>, username=<span class="string">'用户名'</span>, database = <span class="string">'default'</span>, auth=<span class="string">'NOSASL'</span>)</span><br><span class="line"></span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"><span class="comment"># 获得连接的游标</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置开始和结束时间<br>可以用python中的time函数设置时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startdate = <span class="string">'2018-09-01'</span></span><br><span class="line">enddate   = <span class="string">'2018-09-19'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>用Python中的format函数将日期传入{}中</p>
<ul>
<li><p>python中写sql脚本时， 需要用\来进行换行符的转换, \后面不能有空格。</p>
</li>
<li><p>日期用两个{}来代替， 用format函数将开始日期与结束日期传入</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取积分类uv,pv数据</span></span><br><span class="line"></span><br><span class="line">sql_jifenxinxi_an = <span class="string">"""select </span></span><br><span class="line"><span class="string">    count(distinct user_account) as uv, </span></span><br><span class="line"><span class="string">    count(1) as pv </span></span><br><span class="line"><span class="string">from </span></span><br><span class="line"><span class="string">    computer_view.data </span></span><br><span class="line"><span class="string">where </span></span><br><span class="line"><span class="string">    hit_date between "&#123;&#125;" and "&#123;&#125;" </span></span><br><span class="line"><span class="string">    and </span></span><br><span class="line"><span class="string">    (btn_position like "服务-查询-积分信息%" </span></span><br><span class="line"><span class="string">    or </span></span><br><span class="line"><span class="string">    btn_home = "积分-扇形左" </span></span><br><span class="line"><span class="string">    ) </span></span><br><span class="line"><span class="string">limit 1000"""</span>.format(startdate,enddate)</span><br><span class="line"><span class="comment"># format 插入时间</span></span><br><span class="line"></span><br><span class="line">cursor.execute(sql_jifenxinxi_an)</span><br><span class="line"><span class="comment"># 运行此语句</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cursor.fetchall()</span><br><span class="line"></span><br><span class="line"><span class="comment">#fetchall():接收全部的返回结果行.</span></span><br></pre></td></tr></table></figure>
<p>我们可以按照这个格式写工作中需要运行的多个SQL语句。 这样， 当脚本运行的时候， 我们可以腾出时间来去干其他工作， 等过一段时间，所有的SQL语句都跑完了， 我们再进行统一的整理。 </p>
</li>
</ol>
<hr>
<h1 id="其他拓展"><a href="#其他拓展" class="headerlink" title="其他拓展"></a>其他拓展</h1><h2 id="group-by-升级版"><a href="#group-by-升级版" class="headerlink" title="group by 升级版"></a>group by 升级版</h2><ol>
<li>需求背景</li>
</ol>
<p>通过 a1 明细表，获得每个店铺，每个城市，每个省份，每个大区以及全国5月的份的成交量情况。</p>
<table>
<thead>
<tr>
<th>order_id</th>
<th>shop</th>
<th>city</th>
<th>province</th>
<th>area</th>
<th>hit_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>A</td>
<td>西安</td>
<td>陕西</td>
<td>西北大区</td>
<td>2019-05-04</td>
</tr>
<tr>
<td>2</td>
<td>B</td>
<td>上海</td>
<td>上海</td>
<td>华东大区</td>
<td>2019-05-01</td>
</tr>
<tr>
<td>3</td>
<td>C</td>
<td>安康</td>
<td>陕西</td>
<td>西北大区</td>
<td>2019-05-02</td>
</tr>
<tr>
<td>4</td>
<td>D</td>
<td>北京</td>
<td>北京</td>
<td>华中大区</td>
<td>2019-05-21</td>
</tr>
<tr>
<td>5</td>
<td>E</td>
<td>延安</td>
<td>陕西</td>
<td>西北大区</td>
<td>2019-05-03</td>
</tr>
<tr>
<td>6</td>
<td>F</td>
<td>成都</td>
<td>四川</td>
<td>西南大区</td>
<td>2019-05-19</td>
</tr>
<tr>
<td>7</td>
<td>G</td>
<td>汉中</td>
<td>陕西</td>
<td>西北大区</td>
<td>2019-06-04</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>10000</td>
<td>H</td>
<td>郑州</td>
<td>河南</td>
<td>西北大区</td>
<td>2019-05-29</td>
</tr>
</tbody>
</table>
<ol start="2">
<li><p>解法1：</p>
<p>分别写5个sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 全国成交量</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line"><span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 大区成交量</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">area,</span><br><span class="line"><span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">area</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 省成交量</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">area,</span><br><span class="line">province,</span><br><span class="line"><span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">area,</span><br><span class="line">province</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 城市成交量</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">area,</span><br><span class="line">province,</span><br><span class="line">city,</span><br><span class="line"><span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">area,</span><br><span class="line">province,</span><br><span class="line">city</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 店铺成交量</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">area,</span><br><span class="line">province,</span><br><span class="line">city,</span><br><span class="line">shop,</span><br><span class="line"><span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">area,</span><br><span class="line">province,</span><br><span class="line">city,</span><br><span class="line">shop</span><br></pre></td></tr></table></figure>
<p>这种方法太低效了， 还需要在excel中进行合并，比较麻烦。</p>
<ol start="3">
<li>解法2：</li>
</ol>
<p>通过 union 和 union all 对查询结果进行纵向合并<br> union: 对合并后的结果进行去重处理<br> union all : 返回合并后的所有数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span>  a1 <span class="keyword">where</span>  hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> area, <span class="literal">null</span> , <span class="literal">null</span> ,<span class="literal">null</span>, <span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span>  a1 <span class="keyword">where</span>  hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span> <span class="keyword">group</span> <span class="keyword">by</span> area</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> area, province , <span class="literal">null</span> ,<span class="literal">null</span>, <span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span>  a1 <span class="keyword">where</span>  hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span> <span class="keyword">group</span> <span class="keyword">by</span> area, province</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> area, province, city ,<span class="literal">null</span>, <span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span>  a1 <span class="keyword">where</span>  hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span> <span class="keyword">group</span> <span class="keyword">by</span> area, province, city</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> area, province, city ,shop, <span class="keyword">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span>  a1 <span class="keyword">where</span>  hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span> <span class="keyword">group</span> <span class="keyword">by</span> area, province, city, shop</span><br></pre></td></tr></table></figure>
<p> 上述式中有很多 null, 这是因为 union all 拼接的两个表的列数需要相等。</p>
<p>结果如下：</p>
<p><img src="https://i.loli.net/2019/06/10/5cfe6c219ca3f57084.png" alt></p>
<ol start="4">
<li>解法3：</li>
</ol>
<p>利用 <code>union all</code> 比写出5个sql 再在 Excel 中处理简单很多，但是代码比较冗余。可以用<code>grouping sets</code>来进行优化。 此函数可以根据不同维度组合进行聚合。</p>
<p>将<code>union all</code> 语句用<code>grouping sets</code> 进行改写：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    area,</span><br><span class="line">    province,</span><br><span class="line">    city,</span><br><span class="line">    shop,</span><br><span class="line">    <span class="keyword">count</span>(orderid) <span class="keyword">as</span> sales,</span><br><span class="line">    <span class="keyword">grouping_id</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    area,</span><br><span class="line">    province,</span><br><span class="line">    city,</span><br><span class="line">    shop</span><br><span class="line"><span class="keyword">grouping</span> <span class="keyword">sets</span></span><br><span class="line">    (<span class="literal">null</span>,</span><br><span class="line">    area,</span><br><span class="line">    (area,province),</span><br><span class="line">    (area,province,city),</span><br><span class="line">    (area,province,city,shop)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">grouping_id</span></span><br></pre></td></tr></table></figure>
<p>得到结果与利用 <code>union all</code>拼接结果相同。<code>group by</code>后面的字段表示要分组聚合的全部字段， <code>grouping sets</code>后面为 <code>group by</code> 后面各种字段的组合。</p>
<p><code>grouping_id</code>表示每个分组的序号。 1 表示第一个分组、2表示第二个分组。我们可以根据<code>grouping_id</code> 选取我们需要的组合。如果我们需要全国的成交量，则让 <code>grouping_id = 1</code>, 需要每个省的成交量，让 <code>grouping_id = 3</code>。</p>
<ol start="5">
<li>解法4：</li>
</ol>
<p><code>cube</code>函数， 对<code>group by</code>的维度的所有组合进行聚合。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    area,</span><br><span class="line">    province,</span><br><span class="line">    <span class="keyword">count</span>(orderid) <span class="keyword">as</span> sales,</span><br><span class="line">    <span class="keyword">grouping_id</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    area,</span><br><span class="line">    province</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">cube</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">grouping_id</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/10/5cfe78ba58dfb91072.png" alt></p>
<p>以上代码对区域和省份进行了聚合， <code>cube</code> 会先对全部数据进行聚合，即 <code>null, null</code>， 再对<code>area,null</code>进行聚合，然后再对<code>null, province</code>进行聚合，最后再对<code>area,province</code>进行聚合。</p>
<ol start="6">
<li>解法5：<br><code>rollup</code>函数， 和<code>cube</code>类似，是针对 <code>group by</code>所有维度的部分组合。 </li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    area,</span><br><span class="line">    province,</span><br><span class="line">    <span class="keyword">count</span>(orderid) <span class="keyword">as</span> sales,</span><br><span class="line">    <span class="keyword">grouping_id</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    a1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">'2019-05-01'</span> <span class="keyword">and</span> <span class="string">'2019-05-31'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    area,</span><br><span class="line">    province</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">rollup</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">grouping_id</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/10/5cfe79320dfb423235.png" alt></p>
<p>对比<code>cube</code>和<code>rollup</code>得到的结果，我们发现<code>rollup</code>少了<code>null province</code> 这个组合，<code>rollup</code> 是以最左侧指标为主进行组合聚合。</p>
<p>参考资料：<a href="https://mp.weixin.qq.com/s/Xw5DOHHGh838w8YXT9lO5g" target="_blank" rel="noopener">讲讲 group 的plus版-张俊红</a></p>
<hr>
<!-- ## 在 spark 中写 hive 循环, 工具 zeppelim

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">%spark</span><br><span class="line"></span><br><span class="line">for( a &lt;- 0 until 30)&#123;</span><br><span class="line">        // val sql= s&quot;&quot;&quot;use default&quot;&quot;&quot;</span><br><span class="line">    // spark.sql(sql)</span><br><span class="line">    val sql = s&quot;&quot;&quot;</span><br><span class="line">    with a1 as (</span><br><span class="line">    select</span><br><span class="line">        user_account</span><br><span class="line">    from</span><br><span class="line">        computer_view.data</span><br><span class="line">    where</span><br><span class="line">         hit_date between &quot;2018-11-01&quot; and date_add(&quot;2018-11-01&quot;,$&#123;a&#125;)</span><br><span class="line">    union all </span><br><span class="line">        select</span><br><span class="line">        user_account</span><br><span class="line">    from</span><br><span class="line">        computer_view.data</span><br><span class="line">    where</span><br><span class="line">         hit_date between &quot;2018-11-01&quot; and date_add(&quot;2018-11-01&quot;,$&#123;a&#125;))</span><br><span class="line">    select</span><br><span class="line">        count(distinct user_account) as uv</span><br><span class="line">    from</span><br><span class="line">        a1</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    val data = spark.sql(sql)</span><br><span class="line">    println(&quot;day:&quot;, a, &quot;uv:&quot;, data.show())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">``` --&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- # 对用户进行标注</span><br></pre></td></tr></table></figure>
<p>with a1 as(<br>select<br>    hit_date,<br>    user_account,<br>    hit_mon,<br>    first_login<br>from<br>    test.day_dau<br>where<br>    hit_date between ‘{0}-01’ and ‘{0}-31’),<br>a2 as(<br>select<br>    user_account<br>from<br>    test.mon_new_user<br>where<br>    hit_mon = ‘{0}’),<br>a3 as(<br>select<br>    a1.hit_date,<br>    a1.user_account,<br>    a1.hit_mon,<br>    a1.first_login,<br>    a2.user_account as if_new<br>from<br>    a1 left join a2 on<br>    a1.user_account = a2.user_account)<br>insert into table test.dau_ifnew<br>select<br>    user_account,<br>    (case when if_new is not null and hit_date = first_login then ‘new’ else ‘old’ end) as user_label,<br>    hit_date,<br>    hit_mon<br>from<br>    a3<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- </span><br><span class="line">##   取 pv &gt; 3 的用户量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```sql</span><br><span class="line">with a1 as (</span><br><span class="line">SELECT</span><br><span class="line">user_account</span><br><span class="line">FROM</span><br><span class="line">computer_view.data</span><br><span class="line">WHERE</span><br><span class="line">nbtn_name is not null </span><br><span class="line">and</span><br><span class="line">hit_date between &apos;&#123;&#125;&apos; and &apos;&#123;&#125;&apos;</span><br><span class="line">union all </span><br><span class="line">SELECT</span><br><span class="line">user_account</span><br><span class="line">FROM</span><br><span class="line">computer_view.data</span><br><span class="line">WHERE</span><br><span class="line">nbtn_name is not null </span><br><span class="line">and</span><br><span class="line">hit_date between &apos;&#123;&#125;&apos; and &apos;&#123;&#125;&apos;),</span><br><span class="line">a2 as (SELECT</span><br><span class="line"> user_account,</span><br><span class="line">count(user_account) as pv</span><br><span class="line">from </span><br><span class="line">a1</span><br><span class="line">group by </span><br><span class="line">user_account</span><br><span class="line">having</span><br><span class="line">count(user_account) &gt; 3)</span><br><span class="line">SELECT</span><br><span class="line">    count(distinct user_account) as uv</span><br><span class="line">from </span><br><span class="line">a2</span><br><span class="line">``` --&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##   创建临时表</span><br><span class="line"></span><br><span class="line">```sql</span><br><span class="line">use default;</span><br><span class="line">create table test.nine_android_user_version_10</span><br><span class="line">select</span><br><span class="line">    user_account,</span><br><span class="line">    app_version</span><br><span class="line">from</span><br><span class="line">    computer_view.data</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-09-01&apos; and &apos;2018-09-30&apos;</span><br><span class="line">    and</span><br><span class="line">    user_account is not null</span><br><span class="line">    and</span><br><span class="line">    app_version is not null</span><br><span class="line">group by</span><br><span class="line">    user_account,</span><br><span class="line">    app_version</span><br></pre></td></tr></table></figure></p>
<h2 id="原始日志中取数"><a href="#原始日志中取数" class="headerlink" title="原始日志中取数"></a>原始日志中取数</h2><p><code>`</code>sql<br>use default;<br>create table test.nine_user_version_10<br>select<br>    url_par(url_query,’account’) as user_account,<br>    split(url_par(url_query,’AppID’),’ ‘)[1] as app_version<br>from<br>    apache_log.client_ios_sensor<br>where<br>    dt between ‘2018-10-01’ and ‘2018-10-20’<br>    and<br>    url_par(url_query,’account’) is not null<br>    and<br>    url_par(url_query,’AppID’) is not null<br>group by<br>    url_par(url_query,’account’),<br>    split(url_par(url_query,’AppID’),’ ‘)[1]</p>
<p><code>`</code>  –&gt;</p>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><iframe width="560" height="315" src="https://www.youtube.com/embed/f3uqAVsOxsM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>



<hr>
--></div><script type="text/javascript" src="/copyright/js/copyright.js"></script><link rel="stylesheet" type="text/css" href="/copyright/css/copyright.css"><div class="post-copyright"><p><span>本文标题：</span>Hive-SQL学习</p><p><span>文章作者：</span>怪兽宇</p><p><span>发布时间：</span>2019-04-18</p><p><span>最后更新：</span>2020-05-22</p><p><span>原始链接：</span><a href="/2019/04/18/Hive-SQL学习/">https://zhangandyu.github.io/2019/04/18/Hive-SQL学习/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://zhangandyu.github.io/2019/04/18/Hive-SQL学习/"></i></span></p><p><span>版权声明：</span>本文所有权归博主所有，转载请注明署名、出处！Thanks</p></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://zhangandyu.github.io/2019/04/18/Hive-SQL学习/" data-id="cka2iqygy0001hkqklaoz7l0j" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACPElEQVR42u3aS27DMAxF0ex/0+60RSDnPlIpIPpqZORj62TAkCJfL7yut8Vf//3K6p6rVzYvGTJkHMu4bhd55Opb74DVFvnPtKTKkCHjAYzVrVfXhE02SkLw/d5kyJAhI70m2609S4YMGTL4rWthlDxRhgwZMu4ZPNXj76Z3+6daXIYMGQcydqVu37j+Sn9DhgwZRzGucO0Kr/2d/HmKDBkyRjN4gKuNWaQpYGc/MmTImMpIm468mOQF5315jA7sZMiQ8QBGf9iiUwDz4LsEy5Ah4wEMntJ9yDHD0S5eyn74gWTIkDGakQbBvcdqHIPuIEOGjKEMEl55yZoenKVBHA2EyZAh42EMsul0UCNNH1FYlyFDxmhGmpyRIpMUwEEwxX8MMmTImM3oFJakCZoOWxTLYBkyZAxl8IMtHmRr2+KfaZ3PyZAh40BGWrh2hsB4usmTyCDsypAhYwSDfLTzsLRJEB/kyZAhYyjjAosc7qdhlLcKyHNlyJAxm5EemfEqkhe06VDah5ELGTJkjGbwr/F309Sw03iQIUPG0xi1FLBWyvKtB10OGTJkDGX0D8g6Ibt2UvihiJUhQ8YIxhWudFCDh3heyr74f4IMGTJGMNIwt6u4rf0zbAjZMmTIOJZRa2HWBjJaTcr7wluGDBkPYARVb7sx2Un70LCFDBkyZJSaCrzZUMxhZciQIQM3CdL6uEbaHHBlyJBxCIMPVfCWQK0Y/vpxmwwZMg5k9PMuErI76ea2pqYMGTLOY/wA1AnRP3E9DkgAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/Hive/"><i class="fa fa-tag"></i>Hive</a><a href="/tags/sql/"><i class="fa fa-tag"></i>sql</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' ? true : false;
var verify = 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'LWPB8jjoMUiH98OUCjulreBj-gzGzoHsz',
  appKey:'YOWrXQ1oP2QTavuCRp2QeRYV',
  placeholder:'　快来留下你的脚印吧',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/数据分析技能/">数据分析技能</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/Hive-SQL学习/">Hive-SQL学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hive/" style="font-size: 15px;">Hive</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰的网络日志" target="_blank">阮一峰的网络日志</a><ul></ul><a href="http://www.chinawebanalytics.cn/" title="互联网分析在中国" target="_blank">互联网分析在中国</a><ul></ul><a href="https://www.yangzhiping.com/" title="阳志平的网志" target="_blank">阳志平的网志</a><ul></ul><a href="https://maxoxo.me/" title="maxOS" target="_blank">maxOS</a><ul></ul><a href="https://thelongestway.com/" title="The Longest Way" target="_blank">The Longest Way</a><ul></ul><a href="https://christophrehage.cn/" title="Christoph Rehage" target="_blank">Christoph Rehage</a><ul></ul><a href="https://codechina.org/" title="Tinyfool的中文Blog" target="_blank">Tinyfool的中文Blog</a><ul></ul><a href="http://sunny.blogchina.com/" title="梁宁的专栏" target="_blank">梁宁的专栏</a><ul></ul><a href="https://ayearofreadingtheworld.com/" title="A year of reading the world" target="_blank">A year of reading the world</a><ul></ul><a href="http://www.storytellingwithdata.com/blog/" title="storytelling-data" target="_blank">storytelling-data</a><ul></ul><a href="https://github.com/xiaolai/xiaolai.github.io" title="李笑来网站" target="_blank">李笑来网站</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">怪兽宇的小站.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/love/js/love.js"></script><script type="text/javascript" src="/copycode/js/copycode.js"></script><link rel="stylesheet" type="text/css" href="/copycode/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>