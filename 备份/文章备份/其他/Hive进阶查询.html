<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><title>Hive 查询进阶 | 怪兽宇的小站</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','127783955','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Hive 查询进阶</h1><a id="logo" href="/.">怪兽宇的小站</a><p class="description">脚踏实地，仰望星空!</p></div><div id="nav-menu"><a href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/tool/"><i class="fa fa-yelp"> 工具</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Hive 查询进阶</h1><div class="post-content"><h1 id="Hive-查询进阶笔记"><a href="#Hive-查询进阶笔记" class="headerlink" title="Hive 查询进阶笔记"></a>Hive 查询进阶笔记</h1><blockquote>
<p>总结一下最近查询用到的Hive查询。</p>
</blockquote>
<blockquote>
<p>目录：</p>
<ol>
<li>Hive 查询性能优化</li>
<li>求两组数据的并集、交集、差集</li>
<li>Hive 中查询留存率</li>
<li>Hive 中的窗口函数</li>
</ol>
</blockquote>
<h3 id="Hive查询性能优化"><a href="#Hive查询性能优化" class="headerlink" title="Hive查询性能优化"></a>Hive查询性能优化</h3><ol>
<li><p>什么是数据倾斜<br>当我们在Hive上进行查询时，因为数据的分散度不够， 导致大量数据集中在一台或者几台服务器上， 导致数据的计算速度远远低于平均计算速度， 计算过程特别耗时。</p>
</li>
<li><p>数据倾斜的表现<br>任务进度长时间维持在99%，查看任务监控页面，发现只有少量子任务未完成。</p>
</li>
<li><p>如何避免数据倾斜</p>
<blockquote>
<ul>
<li>sql优化</li>
<li>业务逻辑优化</li>
</ul>
</blockquote>
</li>
</ol>
<ul>
<li><strong>当数据量特别大时，用 group by 代替 count(distinct)</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 求客户端每日的去重uv</span><br><span class="line">with a1 as (</span><br><span class="line">    select </span><br><span class="line">        hit_date,</span><br><span class="line">        user_account </span><br><span class="line">    from</span><br><span class="line">        android_data</span><br><span class="line">    where</span><br><span class="line">        hit_date between &apos;2018-10-01&apos; and&apos;2018-10-03&apos;</span><br><span class="line">    group by</span><br><span class="line">        hit_date, user_account</span><br><span class="line">)</span><br><span class="line">select  </span><br><span class="line">    hit_date,</span><br><span class="line">    count(user_account) as uv </span><br><span class="line">from</span><br><span class="line">    a1 </span><br><span class="line">group by</span><br><span class="line">    hit_date</span><br><span class="line">order by </span><br><span class="line">    hit_date</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>join 优化</strong></li>
</ul>
<blockquote>
<p>将条目少的表/子查询放在 Join 操作符的左边。原因是在 Join 操作的 Reduce 阶段，位于 Join 操作符左边的表的内容会被加载进内存，将条目少的表放在左边，可以有效减少发生错误的几率。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># a, b表中， b表最小</span><br><span class="line">select</span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line">from</span><br><span class="line">    b join a on b.ymd = a.ymd AND b.symbol = a.symbol</span><br><span class="line">where</span><br><span class="line">    a.symbol = &apos;apple&apos;</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>避免 union all 子查询中使用 group by</strong> 【替换 count(distinct) 除外】、<strong>count(distinct)、max、min等。</strong> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">use computer_view;</span><br><span class="line">with a1 as (</span><br><span class="line">        select</span><br><span class="line">            user_account,</span><br><span class="line">            hit_date</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-13&apos;</span><br><span class="line">            and</span><br><span class="line">            nbtn_name like &quot;%支付宝%&quot;</span><br><span class="line">        union all </span><br><span class="line">        select</span><br><span class="line">            user_account,</span><br><span class="line">            hit_date</span><br><span class="line">        from</span><br><span class="line">            client_ios_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-13&apos;</span><br><span class="line">        and</span><br><span class="line">        nbtn_name like &quot;%支付宝%&quot;)</span><br><span class="line">select</span><br><span class="line">    hit_date,</span><br><span class="line">    count(user_account) as pv</span><br><span class="line">from</span><br><span class="line">    a1</span><br><span class="line">group by</span><br><span class="line">    hit_date</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>避免不同数据类型进行关联</strong></li>
</ul>
<blockquote>
<p>使用CAST函数对数据类型进行转换，语法为cast(value AS TYPE)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">    a.price_close,</span><br><span class="line">    b.price_close</span><br><span class="line">from</span><br><span class="line">    a join b  on a.user_id = cast(b.user_id as string)</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-11-01&apos; and &apos;2018-11-02&apos;</span><br><span class="line">    and </span><br><span class="line">    a.symbol = &apos;apple&apos;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ul>
<li><strong>无效ID在关联时的数据倾斜问题</strong></li>
</ul>
<blockquote>
<p>把空值的 key 变成一个字符串加上随机数，就能把倾斜的数据分到不同的 reduce 上 ,解决数据倾斜问题。<br>需要用到Case When … Else…End语法</p>
</blockquote>
<p>写法1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Select</span><br><span class="line">    *</span><br><span class="line">From </span><br><span class="line">    a Join  b</span><br><span class="line">On</span><br><span class="line">     a.user_id is not null</span><br><span class="line">And </span><br><span class="line">    a.user_id = b.user_id</span><br><span class="line">Union all</span><br><span class="line">Select</span><br><span class="line">    * </span><br><span class="line">from</span><br><span class="line">    a</span><br><span class="line">where</span><br><span class="line">    a.user_id is null</span><br></pre></td></tr></table></figure></p>
<p>写法2：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Select</span><br><span class="line">    *</span><br><span class="line">From</span><br><span class="line">    a left out Join b</span><br><span class="line">On </span><br><span class="line">Case when </span><br><span class="line">    a.user_id is null </span><br><span class="line">then </span><br><span class="line">    concat(‘dp_hive’,rand() ) </span><br><span class="line">else </span><br><span class="line">    a.user_id = b.user_id end;</span><br></pre></td></tr></table></figure></p>
<hr>
<ul>
<li><p><strong>在查询中， 避免使用 select *, 使用条件限制取需要的列。</strong></p>
</li>
<li><p><strong>在使用 Join 进行外关联时， 将副表的过滤条件写在 where 后面，会先全表关联， 再进行过滤， 这样会耗费资源。</strong></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line">FROM</span><br><span class="line">    b JOIN a ON b.ymd = a.ymd AND b.symbol = a.symbol</span><br><span class="line">WHERE</span><br><span class="line">    s.symbol = &apos;APPLE&apos;</span><br></pre></td></tr></table></figure>
<p>正确的写法是将 where 条件卸载 on 后面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line">FROM</span><br><span class="line">    b JOIN a ON ( b.ymd = a.ymd AND b.symbol = a.symbol and s.symbol = &apos;APPLE&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="求两组数据的交集，-并集，-差集"><a href="#求两组数据的交集，-并集，-差集" class="headerlink" title="求两组数据的交集， 并集， 差集"></a>求两组数据的交集， 并集， 差集</h3><ol>
<li><strong>并集</strong></li>
</ol>
<p>union 与 union all </p>
<blockquote>
<p>union, 结果包含所有行， 并删除重复行<br>unoin all, 结果包含所有行， 但不删除重复行</p>
</blockquote>
<p>写法1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">use computer_view;</span><br><span class="line">with a1 as (</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-02&apos;</span><br><span class="line">            and</span><br><span class="line">            nbtn_name like &quot;%支付宝%&quot;</span><br><span class="line">        union </span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-02&apos;</span><br><span class="line">        and</span><br><span class="line">        nbtn_name like &quot;%手淘%&quot;)</span><br><span class="line">select</span><br><span class="line">    count(user_account) as pv</span><br><span class="line">from</span><br><span class="line">    a1</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>点击支付宝或者手淘活动的人数总共有 435499 人</p>
</blockquote>
<p>写法2：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">use computer_view;</span><br><span class="line">with a1 as (</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-02&apos;</span><br><span class="line">            and</span><br><span class="line">            nbtn_name like &quot;%支付宝%&quot;</span><br><span class="line">        union all </span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-02&apos;</span><br><span class="line">        and</span><br><span class="line">        nbtn_name like &quot;%手淘%&quot;)</span><br><span class="line">select</span><br><span class="line">    count(user_account) as pv</span><br><span class="line">from</span><br><span class="line">    a1</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>点击支付宝或者手淘活动的次数为 665935</p>
</blockquote>
<hr>
<ol start="2">
<li><strong>交集-intersect函数</strong></li>
</ol>
<p>写法1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">use computer_view;</span><br><span class="line">with a1 as (</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-02&apos;</span><br><span class="line">            and</span><br><span class="line">            nbtn_name like &quot;%支付宝%&quot;</span><br><span class="line">        intersect</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_ios_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-02&apos;</span><br><span class="line">        and</span><br><span class="line">        nbtn_name like &quot;%手淘%&quot;)</span><br><span class="line">select</span><br><span class="line">    count(user_account) as pv</span><br><span class="line">from</span><br><span class="line">    a1</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p> 点击支付宝又点击手淘活动的人数为 66174</p>
</blockquote>
<hr>
<ol start="3">
<li><strong>差集-except 函数 与 join写法</strong></li>
</ol>
<p>写法1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">use computer_view;</span><br><span class="line">with a1 as (</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-25&apos;</span><br><span class="line">            and</span><br><span class="line">            nbtn_name like &quot;%支付宝%&quot;</span><br><span class="line">        except</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-25&apos;</span><br><span class="line">        and</span><br><span class="line">        nbtn_name like &quot;%手淘%&quot;)</span><br><span class="line">select</span><br><span class="line">    count(user_account) as pv</span><br><span class="line">from</span><br><span class="line">    a1</span><br></pre></td></tr></table></figure></p>
<p>写法2：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">use computer_view;</span><br><span class="line">with a1 as (</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-01&apos; and &apos;2018-12-25&apos;</span><br><span class="line">            and</span><br><span class="line">            nbtn_name like &quot;%支付宝%&quot;),</span><br><span class="line">a2 as (</span><br><span class="line">        select</span><br><span class="line">            user_account</span><br><span class="line">        from</span><br><span class="line">            client_android_log_view</span><br><span class="line">        where</span><br><span class="line">            hit_date between &apos;2018-12-20&apos; and &apos;2018-12-25&apos;</span><br><span class="line">        and</span><br><span class="line">        nbtn_name like &quot;%支付宝%&quot;)</span><br><span class="line">select</span><br><span class="line">    count(distinct a1.user_account) as pv</span><br><span class="line">from</span><br><span class="line">    a1 left outer join a2 </span><br><span class="line">    on a1.user_account = a2.user_account</span><br><span class="line">    and a2.user_account is  null</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>只参加支付宝活动， 没有参加手淘活动的人数为 369325<br>在求差集时， 需要注意前后顺序， 否则会出现逻辑错误<br>可以发现， 差集 + 交集 =并集， 369325 +  66174 = 435499</p>
</blockquote>
<hr>
<h3 id="HIVE中查询留存率"><a href="#HIVE中查询留存率" class="headerlink" title="HIVE中查询留存率"></a>HIVE中查询留存率</h3><blockquote>
<p>求11月10-15号每天的1、3、7日留存率</p>
</blockquote>
<p>方法1.</p>
<blockquote>
<ol>
<li>统计每天的uv</li>
<li>统计上一天与本天uv的交集， 需要每一天做交集</li>
<li>算出留存率</li>
</ol>
</blockquote>
<p>方法2：</p>
<blockquote>
<ol>
<li>统计每天的uv</li>
<li>使用date_add 函数， 一次性求出10-15号每一天的次1、3、7日留存</li>
<li>算出留存率</li>
</ol>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 统计10-15号每天uv</span><br><span class="line">SELECT  </span><br><span class="line">    hit_date,</span><br><span class="line">    count(distinct user_account) as uv</span><br><span class="line">FROM</span><br><span class="line">    computer_view.client_android_log_view</span><br><span class="line">WHERE   </span><br><span class="line">    hit_date between  &apos;2018-11-10&apos; and &apos;2018-11-15&apos;</span><br><span class="line">group BY </span><br><span class="line">    hit_date</span><br><span class="line">order BY </span><br><span class="line">    hit_date</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># 统计10-15号每天的次日留存数， 统计次3、7日留存只需将1换为3、7</span><br><span class="line">with a1 as (</span><br><span class="line">    select </span><br><span class="line">        user_account,</span><br><span class="line">        hit_date</span><br><span class="line">    from </span><br><span class="line">        computer_view.client_android_log_view</span><br><span class="line">    where </span><br><span class="line">        hit_date between  &apos;2018-11-10&apos; and &apos;2018-11-15&apos;</span><br><span class="line">),</span><br><span class="line">a2 as (</span><br><span class="line">        select </span><br><span class="line">        user_account,</span><br><span class="line">        hit_date</span><br><span class="line">    from </span><br><span class="line">        computer_view.client_android_log_view</span><br><span class="line">    where </span><br><span class="line">        hit_date between &apos;2018-11-10&apos; and &apos;2018-11-25&apos;</span><br><span class="line">)</span><br><span class="line">select </span><br><span class="line">    a1.hit_date,</span><br><span class="line">    count(distinct a1.user_account) as uv</span><br><span class="line">from</span><br><span class="line">    a1 join a2 on a1.user_account = a2.user_account</span><br><span class="line">WHERE   </span><br><span class="line">    a2.hit_date =  date_add(a1.hit_date, 1) </span><br><span class="line">group by </span><br><span class="line">    a1.hit_date</span><br><span class="line">order BY</span><br><span class="line">    a1.hit_date</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="HIVE中的窗口函数"><a href="#HIVE中的窗口函数" class="headerlink" title="HIVE中的窗口函数"></a>HIVE中的窗口函数</h3><ol>
<li><strong>over 函数</strong><blockquote>
<p>语法： over(partition by ….)<br>作用： 与聚合函数sum(), count(), avg()等结合使用， 实现分组聚合的功能</p>
</blockquote>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 根据日期 和 mac_id 进行分组求每组的数量和， 并按日期排序</span><br><span class="line">select</span><br><span class="line">    hit_date, </span><br><span class="line">    mac_id,</span><br><span class="line">    mac_color,</span><br><span class="line">    day_num,</span><br><span class="line">    sum(day_num) over(partition by hit_date, mac_id order by hit_date) as sum_num</span><br><span class="line">from</span><br><span class="line">    test.datas</span><br></pre></td></tr></table></figure>
<hr>
<table>
<thead>
<tr>
<th>hit_date</th>
<th>mac_id</th>
<th>mac_color</th>
<th>day_num</th>
<th>sum_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>20171011</td>
<td>1292</td>
<td>金色</td>
<td>11</td>
<td>89</td>
</tr>
<tr>
<td>20171011</td>
<td>1292</td>
<td>黑色</td>
<td>19</td>
<td>89</td>
</tr>
<tr>
<td>20171011</td>
<td>1292</td>
<td>粉金</td>
<td>58</td>
<td>89</td>
</tr>
<tr>
<td>20171011</td>
<td>1292</td>
<td>金色</td>
<td>1</td>
<td>89</td>
</tr>
<tr>
<td>20171011</td>
<td>2013</td>
<td>金色</td>
<td>9</td>
<td>22</td>
</tr>
<tr>
<td>20171011</td>
<td>2013</td>
<td>金色</td>
<td>3</td>
<td>22</td>
</tr>
<tr>
<td>20171012</td>
<td>1292</td>
<td>金色</td>
<td>5</td>
<td>18</td>
</tr>
<tr>
<td>20171012</td>
<td>1292</td>
<td>粉金</td>
<td>1</td>
<td>18</td>
</tr>
<tr>
<td>20171012</td>
<td>2013</td>
<td>粉金</td>
<td>1</td>
<td>7</td>
</tr>
<tr>
<td>20171012</td>
<td>2013</td>
<td>金色</td>
<td>6</td>
<td>7</td>
</tr>
<tr>
<td>20171013</td>
<td>1292</td>
<td>黑色</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>20171013</td>
<td>2013</td>
<td>粉金</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># group by 语句</span><br><span class="line">select</span><br><span class="line">    hit_date,</span><br><span class="line">    mac_id,</span><br><span class="line">    sum(day_num) </span><br><span class="line">from</span><br><span class="line">    test.data</span><br><span class="line">group by</span><br><span class="line">    hit_date,</span><br><span class="line">    mac_id</span><br><span class="line">order by</span><br><span class="line">    hit_date</span><br></pre></td></tr></table></figure>
<hr>
<table>
<thead>
<tr>
<th>day_id</th>
<th>mac_id</th>
<th>sum_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>20171011</td>
<td>124609</td>
<td>1</td>
</tr>
<tr>
<td>20171011</td>
<td>20130</td>
<td>22</td>
</tr>
<tr>
<td>20171011</td>
<td>12922</td>
<td>89</td>
</tr>
<tr>
<td>20171012</td>
<td>12922</td>
<td>18</td>
</tr>
<tr>
<td>20171012</td>
<td>20130</td>
<td>7</td>
</tr>
<tr>
<td>20171013</td>
<td>12922</td>
<td>1</td>
</tr>
<tr>
<td>20171013</td>
<td>20130</td>
<td>2</td>
</tr>
</tbody>
</table>
<blockquote>
<p>over(partition by)  与 group by 的区别<br>grou by 字段只能显示与分组聚合相关的字段， 而 over(partition by)<br>可以显示所有字段</p>
</blockquote>
<hr>
<ol start="2">
<li><strong>LAG 和 LEAD 函数</strong><blockquote>
<p>语法： LAG(col,n,DEFAULT) 用于统计窗口内往上第n行值;<br>LEAD(col,n,DEFAULT) 用于统计窗口内往下第n行值</p>
</blockquote>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 计算11月1-10号， 不同日期同一用户登陆客户端 pv 量对比</span><br><span class="line"></span><br><span class="line">with a1 as (select</span><br><span class="line">    user_account,</span><br><span class="line">    count(user_account) as pv,</span><br><span class="line">    hit_date</span><br><span class="line">from</span><br><span class="line">    computer_view.client_android_log_view</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-11-01&apos; and&apos;2018-11-10&apos;</span><br><span class="line">group by</span><br><span class="line">    user_account, hit_date)</span><br><span class="line">select</span><br><span class="line">    user_account,</span><br><span class="line">    a1.hit_date,</span><br><span class="line">    a1.pv,</span><br><span class="line">    lag(a1.pv, 1) over (partition by user_account order by user_account, a1.hit_date) as pv1,</span><br><span class="line">    lead(a1.pv, 1) over(partition by user_account  order by user_account, a1.hit_date) as pv2</span><br><span class="line">from</span><br><span class="line">    a1</span><br><span class="line">limit 100</span><br></pre></td></tr></table></figure>
<hr>
<ol start="3">
<li><strong>first_value() 和 last_value() 函数 =</strong><blockquote>
<p>语法:first_value() ：比较每个用户浏览次数与第一天浏览次数进行比较，查询返回当前浏览次数以及第一天浏览次数<br>last_value() ： 比较每个用户浏览次数与最新一天浏览次数进行比较，查询返回当前浏览次数以及最新一天浏览次数</p>
</blockquote>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">with a1 as (select</span><br><span class="line">    distinct user_account,</span><br><span class="line">    count(user_account) as pv,</span><br><span class="line">    hit_date</span><br><span class="line">from</span><br><span class="line">    computer_view.client_android_log_view</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-11-01&apos; and&apos;2018-11-10&apos;</span><br><span class="line">group by</span><br><span class="line">    user_account, hit_date)</span><br><span class="line">select</span><br><span class="line">    distinct user_account,</span><br><span class="line">    a1.hit_date,</span><br><span class="line">    a1.pv,</span><br><span class="line">    first_value(a1.pv) over (partition by user_account order by user_account, a1.hit_date) as pv1,</span><br><span class="line">    last_value(a1.pv) over(partition by user_account  order by user_account, a1.hit_date) as pv2</span><br><span class="line">from</span><br><span class="line">    a1</span><br><span class="line">limit 100</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><strong>rank、dense_rank、 row_number  排序函数</strong></li>
</ol>
<blockquote>
<p>说明： rank函数， 返回数据项在分组中的排名， 排名相等的会留下空位， 如1、2、2、4<br>dense_rank函数， 返回数据项在分组中的排名， 排名相等的不会留下空位， 如1、2、2、3<br>row_number函数， 返回数据项在分组中的排名， 排名不管数据是否相等， 如1、2、3、4</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">    a,</span><br><span class="line">    row_number() over(order by b) row_number,</span><br><span class="line">    rank() over(order by b) rank,</span><br><span class="line">    dense_rank() over(order by b) dense_rank </span><br><span class="line">from </span><br><span class="line">    lijie.test_rank</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>a</th>
<th>row_number</th>
<th>rank</th>
<th>dense_rank</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>C</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>D</td>
<td>3</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>B</td>
<td>4</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>E</td>
<td>5</td>
<td>5</td>
<td>4</td>
</tr>
<tr>
<td>F</td>
<td>6</td>
<td>6</td>
<td>5</td>
</tr>
<tr>
<td>G</td>
<td>7</td>
<td>7</td>
<td>6</td>
</tr>
</tbody>
</table>
<hr>
<ol start="5">
<li>业务问题</li>
</ol>
<ul>
<li>求点击【确认充值】按钮的上一步点击的名称</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">use default;</span><br><span class="line">with a as (</span><br><span class="line">select</span><br><span class="line">    user_account,</span><br><span class="line">    btn_name,</span><br><span class="line">    lag(btn_name, 1) over (partition by user_account order by create_timestamp) as previous_btn_name</span><br><span class="line">from</span><br><span class="line">    computer_view.client_android_log_view</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-11-01&apos; and&apos;2018-11-01&apos;</span><br><span class="line">    and</span><br><span class="line">    btn_name is not null</span><br><span class="line">having</span><br><span class="line">    btn_name like &apos;确认支付&apos;</span><br><span class="line">)</span><br><span class="line">select</span><br><span class="line">    previous_btn_name,</span><br><span class="line">    count(distinct user_account) as c</span><br><span class="line">from</span><br><span class="line">    a</span><br><span class="line">group by</span><br><span class="line">    previous_btn_name</span><br><span class="line">order by</span><br><span class="line">    c desc</span><br><span class="line">limit</span><br><span class="line">    1000</span><br></pre></td></tr></table></figure>
<p><img src="http://plosti2dy.bkt.clouddn.com/%E7%A1%AE%E8%AE%A4%E6%94%AF%E4%BB%98%E4%B8%8A%E4%B8%80%E6%AD%A5.png" alt="确认支付上一步"></p>
<ul>
<li>上一步点击的名称我已经知道了， 现在要想 之前通过上一步点击这些条件之后， 再点击【确认支付】按钮的 去重uv</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">use default;</span><br><span class="line">with a as (</span><br><span class="line">select</span><br><span class="line">    user_account,</span><br><span class="line">    btn_name,</span><br><span class="line">    lag(btn_name, 1) over (partition by user_account order by create_timestamp) as previous_btn_name</span><br><span class="line">from</span><br><span class="line">    computer_view.client_android_log_view</span><br><span class="line">where</span><br><span class="line">    hit_date between &apos;2018-11-01&apos; and&apos;2018-11-01&apos;</span><br><span class="line">    and</span><br><span class="line">    btn_name is not null</span><br><span class="line">having</span><br><span class="line">    btn_name like &apos;确认支付&apos;</span><br><span class="line">)</span><br><span class="line">select</span><br><span class="line">    count(distinct user_account) as c</span><br><span class="line">from</span><br><span class="line">    a</span><br><span class="line">where</span><br><span class="line">    (previous_btn_name like &quot;%10元%&quot; or </span><br><span class="line">    previous_btn_name like &quot;%30元%&quot; or</span><br><span class="line">    previous_btn_name like &quot;%50元%&quot; or</span><br><span class="line">    previous_btn_name like &quot;%10元%&quot; or </span><br><span class="line">    previous_btn_name like &quot;%30元%&quot; or</span><br><span class="line">    previous_btn_name like &quot;%50元%&quot; or</span><br><span class="line">    previous_btn_name like &quot;%100元%&quot; or</span><br><span class="line">    previous_btn_name like &quot;%200元%&quot; or</span><br><span class="line">    previous_btn_name like &quot;%300元%&quot; )</span><br></pre></td></tr></table></figure>
<blockquote>
<p>125752</p>
</blockquote>
<p>参考：<br><a href="https://www.iteblog.com/archives/category/hive/" target="_blank" rel="noopener">过往记忆——hive</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&apos;SELECT hit_date, btn_navigation ,SUM(uv), SUM(pv) \</span><br><span class="line">FROM ( \</span><br><span class="line">select  \</span><br><span class="line">    btn_navigation,  \</span><br><span class="line">    hit_date,  \</span><br><span class="line">    count(distinct user_account) uv,  \</span><br><span class="line">    count(user_account) pv  \</span><br><span class="line">from  \</span><br><span class="line">    computer_view.client_android_log_view  \</span><br><span class="line">where  \</span><br><span class="line">    hit_date between &quot;&#123;&#125;&quot; and &quot;&#123;&#125;&quot;  \</span><br><span class="line">    and  \</span><br><span class="line">    app_version = &quot;7.1.0&quot;  \</span><br><span class="line">group by  \</span><br><span class="line">    btn_navigation, hit_date  \</span><br><span class="line">order by  \</span><br><span class="line">    btn_navigation, hit_date \</span><br><span class="line">) cb_view  \</span><br><span class="line">GROUP BY hit_date, btn_navigation</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 打断</span><br><span class="line">select</span><br><span class="line">substring_index(page_url, &apos;?&apos;, 1),</span><br><span class="line">count(distinct user_tracking_id) as uv,</span><br><span class="line">count(page_url) as pv </span><br><span class="line">from </span><br><span class="line">    computer_view.jt_wap_log_view</span><br><span class="line">where</span><br><span class="line">hit_date between &apos;2019-04-09&apos; and &apos;2019-04-09&apos; </span><br><span class="line">and </span><br><span class="line">campaign like &quot;%scjh-scep-tcnr-9yuanka%&quot;</span><br><span class="line">group by </span><br><span class="line">substring_index(page_url, &apos;?&apos;, 1)</span><br><span class="line">order by </span><br><span class="line">    uv DESC</span><br></pre></td></tr></table></figure>
<h3 id="在-spark-中写-hive-循环-工具-zeppelim"><a href="#在-spark-中写-hive-循环-工具-zeppelim" class="headerlink" title="在 spark 中写 hive 循环, 工具 zeppelim"></a>在 spark 中写 hive 循环, 工具 zeppelim</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">%spark</span><br><span class="line"></span><br><span class="line">for( a &lt;- 0 until 30)&#123;</span><br><span class="line">        // val sql= s&quot;&quot;&quot;use default&quot;&quot;&quot;</span><br><span class="line">    // spark.sql(sql)</span><br><span class="line">    val sql = s&quot;&quot;&quot;</span><br><span class="line">    with a1 as (</span><br><span class="line">    select</span><br><span class="line">        user_account</span><br><span class="line">    from</span><br><span class="line">        computer_view.client_android_log_view</span><br><span class="line">    where</span><br><span class="line">         hit_date between &quot;2018-11-01&quot; and date_add(&quot;2018-11-01&quot;,$&#123;a&#125;)</span><br><span class="line">    union all </span><br><span class="line">        select</span><br><span class="line">        user_account</span><br><span class="line">    from</span><br><span class="line">        computer_view.client_ios_log_view</span><br><span class="line">    where</span><br><span class="line">         hit_date between &quot;2018-11-01&quot; and date_add(&quot;2018-11-01&quot;,$&#123;a&#125;))</span><br><span class="line">    select</span><br><span class="line">        count(distinct user_account) as uv</span><br><span class="line">    from</span><br><span class="line">        a1</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    val data = spark.sql(sql)</span><br><span class="line">    println(&quot;day:&quot;, a, &quot;uv:&quot;, data.show())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' ? true : false;
var verify = 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'LWPB8jjoMUiH98OUCjulreBj-gzGzoHsz',
  appKey:'YOWrXQ1oP2QTavuCRp2QeRYV',
  placeholder:'　快来留下你的脚印吧',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/数据分析技能/">数据分析技能</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/18/Hive-SQL学习/">Hive-SQL学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/技能-pandas库学习/">Python-Pandas库学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/技能-python基础学习/">python基础学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/12/技能-python爬虫学习/">Python爬虫学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Hive/" style="font-size: 15px;">Hive</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰的网络日志" target="_blank">阮一峰的网络日志</a><ul></ul><a href="http://www.chinawebanalytics.cn/" title="互联网分析在中国" target="_blank">互联网分析在中国</a><ul></ul><a href="https://www.yangzhiping.com/" title="阳志平的网志" target="_blank">阳志平的网志</a><ul></ul><a href="https://maxoxo.me/" title="maxOS" target="_blank">maxOS</a><ul></ul><a href="https://thelongestway.com/" title="The Longest Way" target="_blank">The Longest Way</a><ul></ul><a href="https://christophrehage.cn/" title="Christoph Rehage" target="_blank">Christoph Rehage</a><ul></ul><a href="https://codechina.org/" title="Tinyfool的中文Blog" target="_blank">Tinyfool的中文Blog</a><ul></ul><a href="http://sunny.blogchina.com/" title="梁宁的专栏" target="_blank">梁宁的专栏</a><ul></ul><a href="https://ayearofreadingtheworld.com/" title="A year of reading the world" target="_blank">A year of reading the world</a><ul></ul><a href="http://www.storytellingwithdata.com/blog/" title="storytelling-data" target="_blank">storytelling-data</a><ul></ul><a href="https://github.com/xiaolai/xiaolai.github.io" title="李笑来网站" target="_blank">李笑来网站</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">怪兽宇的小站.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/love/js/love.js"></script><script type="text/javascript" src="/copycode/js/copycode.js"></script><link rel="stylesheet" type="text/css" href="/copycode/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>